[BEGIN] 2022/12/20 10:21:06
=====================================================================================================================================================================================================================
正在安装:
 expect                                           x86_64                                           5.45-14.el7_1                                              OS-YUM                                           262 k
为依赖而安装:
 tcl                                              x86_64                                           1:8.5.13-8.el7                                             OS-YUM                                           1.9 M
事务概要
=====================================================================================================================================================================================================================
安装  1 软件包 (+1 依赖软件包)
总下载量：2.1 M
安装大小：4.9 M
Downloading packages:
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
总计                                                                                                                                                                                 7.9 MB/s | 2.1 MB  00:00:00     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  正在安装    : 1:tcl-8.5.13-8.el7.x86_64                                                                                                                                                                        1/2 
  正在安装    : expect-5.45-14.el7_1.x86_64                                                                                                                                                                      2/2 
  验证中      : 1:tcl-8.5.13-8.el7.x86_64                                                                                                                                                                        1/2 
  验证中      : expect-5.45-14.el7_1.x86_64                                                                                                                                                                      2/2 
已安装:
  expect.x86_64 0:5.45-14.el7_1                                                                                                                                                                                      
作为依赖被安装:
  tcl.x86_64 1:8.5.13-8.el7                                                                                                                                                                                          
完毕！
所有节点 root 用户配置互信：                                                                                  
# 192.168.2.26:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.26:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.26:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.27:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.27:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.27:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.28:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.28:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.28:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.29:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.29:22 SSH-2.0-OpenSSH_7.4
# 192.168.2.29:22 SSH-2.0-OpenSSH_7.4
spawn scp -rq /root/.ssh root@192.168.2.26:~
send: spawn id exp6 not open
    while executing
"send "123456\r""
spawn ssh-copy-id -i root@192.168.2.26
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.
		(if you think this is a mistake, you may want to use -f option)
send: spawn id exp6 not open
    while executing
"send "123456\r""
spawn scp -rq /root/.ssh root@192.168.2.27:~
root@192.168.2.27's password: 
spawn ssh-copy-id -i root@192.168.2.27
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.
		(if you think this is a mistake, you may want to use -f option)
send: spawn id exp6 not open
    while executing
"send "123456\r""
spawn scp -rq /root/.ssh root@192.168.2.28:~
root@192.168.2.28's password: 
spawn ssh-copy-id -i root@192.168.2.28
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.
		(if you think this is a mistake, you may want to use -f option)
send: spawn id exp6 not open
    while executing
"send "123456\r""
spawn scp -rq /root/.ssh root@192.168.2.29:~
root@192.168.2.29's password: 
spawn ssh-copy-id -i root@192.168.2.29
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.
		(if you think this is a mistake, you may want to use -f option)
send: spawn id exp6 not open
    while executing
"send "123456\r""
拷贝脚本以及安装包到监视器节点 192.168.2.29                                                                                  
dwmonitor_node.sh                                                                                                                                                                  100%  279    73.2KB/s   00:00    
DMShellInstall                                                                                                                                                                     100%  118KB  26.9MB/s   00:00    
dm8_20221121_x86_rh6_64.iso                                                                                                                                                        100%  959MB  68.3MB/s   00:14    


拷贝脚本以及安装包到节点：192.168.2.27                                                                                  

dwnode.sh                                                                                                                                                                          100%  454    55.1KB/s   00:00    
DMShellInstall                                                                                                                                                                     100%  118KB  26.4MB/s   00:00    
dm8_20221121_x86_rh6_64.iso                                                                                                                                                        100%  959MB  69.9MB/s   00:13    

拷贝脚本以及安装包到节点：192.168.2.28                                                                                  

dwnode.sh                                                                                                                                                                          100%  454   101.3KB/s   00:00    
DMShellInstall                                                                                                                                                                     100%  118KB   9.7MB/s   00:00    
dm8_20221121_x86_rh6_64.iso                                                                                                                                                        100%  959MB  87.2MB/s   00:11    

达梦数据库开始安装：                                                                                  

#==============================================================#                                                                                  
打印系统信息                                                                                    
#==============================================================#                                                                                  

服务器时间:                                                                                      

2022年 12月 20日 星期二 17:25:39 CST

操作系统版本:                                                                                   

NAME="CentOS Linux"
VERSION="7 (Core)"
ID="centos"
ID_LIKE="rhel fedora"
VERSION_ID="7"
PRETTY_NAME="CentOS Linux 7 (Core)"
ANSI_COLOR="0;31"
CPE_NAME="cpe:/o:centos:centos:7"
HOME_URL="https://www.centos.org/"
BUG_REPORT_URL="https://bugs.centos.org/"

CENTOS_MANTISBT_PROJECT="CentOS-7"
CENTOS_MANTISBT_PROJECT_VERSION="7"
REDHAT_SUPPORT_PRODUCT="centos"
REDHAT_SUPPORT_PRODUCT_VERSION="7"


cpu信息:                                                                                            

Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                1
On-line CPU(s) list:   0
Thread(s) per core:    1
Core(s) per socket:    1
座：                 1
NUMA 节点：         1
厂商 ID：           GenuineIntel
CPU 系列：          6
型号：              142
型号名称：        Intel(R) Core(TM) i7-8565U CPU @ 1.80GHz
步进：              12
CPU MHz：             1992.001
BogoMIPS：            3984.00
超管理器厂商：  VMware
虚拟化类型：     完全
L1d 缓存：          32K
L1i 缓存：          32K
L2 缓存：           256K
L3 缓存：           8192K
NUMA 节点0 CPU：    0
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single ssbd ibrs ibpb stibp ibrs_enhanced fsgsbase tsc_adjust bmi1 avx2 smep bmi2 invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 arat md_clear spec_ctrl intel_stibp flush_l1d arch_capabilities

内存信息:                                                                                         

              total        used        free      shared  buff/cache   available
Mem:           2827         259        1353           9        1214        2414
Swap:          8191           0        8191
              total        used        free      shared  buff/cache   available
Mem:           2.8G        259M        1.3G        9.4M        1.2G        2.4G
Swap:          8.0G          0B        8.0G

挂载信息:                                                                                         

/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=dc24af02-0269-4d90-88b9-c6fdb8c27470 /boot                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0
/dev/sr0                /mnt/cdrom              iso9660 defaults        0 0

目录信息:                                                                                         

文件系统                 容量  已用  可用 已用% 挂载点
devtmpfs                 1.4G     0  1.4G    0% /dev
tmpfs                    1.4G     0  1.4G    0% /dev/shm
tmpfs                    1.4G  9.5M  1.4G    1% /run
tmpfs                    1.4G     0  1.4G    0% /sys/fs/cgroup
/dev/mapper/centos-root   91G  2.7G   89G    3% /
/dev/sr0                 4.4G  4.4G     0  100% /mnt/cdrom
/dev/sda1               1014M  151M  864M   15% /boot
tmpfs                    283M     0  283M    0% /run/user/0

#==============================================================#                                                                                  
关闭 SWAP 功能                                                                                    
#==============================================================#                                                                                  

              total        used        free      shared  buff/cache   available
Mem:        2895196      259012     1392724        9640     1243460     2478432
Swap:             0           0           0

#/dev/mapper/centos-swap swap                    swap    defaults        0 0

#==============================================================#                                                                                  
禁用防火墙                                                                                       
#==============================================================#                                                                                  

● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)

12月 20 17:23:23 centos7 systemd[1]: Starting firewalld - dynamic firewall daemon...
12月 20 17:23:23 centos7 systemd[1]: Started firewalld - dynamic firewall daemon.
12月 20 17:23:23 centos7 firewalld[789]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure configuration option. It will be removed in a future release. Please consider disabling it now.
12月 20 17:25:39 centos7 systemd[1]: Stopping firewalld - dynamic firewall daemon...
12月 20 17:25:39 centos7 systemd[1]: Stopped firewalld - dynamic firewall daemon.

#==============================================================#                                                                                  
禁用 selinux                                                                                        
#==============================================================#                                                                                  

SELINUX=disabled
SELINUXTYPE=targeted 

#==============================================================#                                                                                  
配置主机名                                                                                       
#==============================================================#                                                                                  

   Static hostname: dw01
         Icon name: computer-vm
           Chassis: vm
        Machine ID: f4a41440d98d417dbb5516d46b966467
           Boot ID: ba99e32e677f4f4184ac8459b55ca8fd
    Virtualization: vmware
  Operating System: CentOS Linux 7 (Core)
       CPE OS Name: cpe:/o:centos:centos:7
            Kernel: Linux 3.10.0-1160.el7.x86_64
      Architecture: x86-64

#==============================================================#                                                                                  
配置时间同步                                                                                    
#==============================================================#                                                                                  

Removed symlink /etc/systemd/system/multi-user.target.wants/chronyd.service.
● chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:chronyd(8)
           man:chrony.conf(5)

12月 20 17:23:22 centos7 systemd[1]: Starting NTP client/server...
12月 20 17:23:22 centos7 chronyd[762]: chronyd version 3.4 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +SECHASH +IPV6 +DEBUG)
12月 20 17:23:22 centos7 chronyd[762]: Frequency 0.000 +/- 1000000.000 ppm read from /var/lib/chrony/drift
12月 20 17:23:22 centos7 systemd[1]: Started NTP client/server.
12月 20 17:25:39 dw01 systemd[1]: Stopping NTP client/server...
12月 20 17:25:39 dw01 systemd[1]: Stopped NTP client/server.
2022年 12月 20日 星期二 17:25:39 CST

no crontab for root

#==============================================================#                                                                                  
禁用透明大页 & 禁用NUMA & 开启 I/0 schedule                                                                                  
#==============================================================#                                                                                  

index=0
kernel=/boot/vmlinuz-3.10.0-1160.el7.x86_64
args="ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet LANG=zh_CN.UTF-8 numa=off transparent_hugepage=never elevator=deadline"
--
index=1
kernel=/boot/vmlinuz-0-rescue-f4a41440d98d417dbb5516d46b966467
args="ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet numa=off transparent_hugepage=never elevator=deadline"

#==============================================================#                                                                                  
创建 DMDBA 用户以及安装目录                                                                                  
#==============================================================#                                                                                  

更改用户 dmdba 的密码 。
passwd：所有的身份验证令牌已经成功更新。

dmdba:x:54321:54321::/home/dmdba:/bin/bash

uid=54321(dmdba) gid=54321(dinstall) 组=54321(dinstall),54322(dmdba)

#==============================================================#                                                                                  
配置系统参数                                                                                    
#==============================================================#                                                                                  

fs.aio-max-nr = 1048576
fs.file-max = 6815744
kernel.shmmni = 4096
kernel.sem = 250 32000 100 128
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
vm.swappiness = 0
vm.dirty_background_ratio = 3
vm.dirty_ratio = 80
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100
sysctl: cannot stat /proc/sys/vm/numa_stat: 没有那个文件或目录
vm.overcommit_memory = 0

#==============================================================#                                                                                  
配置用户限制                                                                                    
#==============================================================#                                                                                  

dmdba - nice   0
dmdba - as     unlimited
dmdba - fsize  unlimited
dmdba - nproc  131072
dmdba - nofile 131072
dmdba - core   unlimited
dmdba - data   unlimited
root  - nice   0
root  - as     unlimited
root  - fsize  unlimited
root  - nproc  131072
root  - nofile 131072
root  - core   unlimited
root  - data   unlimited

[Manager]
DefaultLimitCORE=infinity
DefaultLimitNOFILE=65536
DefaultLimitNPROC=10240

auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_securetty.so
auth       substack     system-auth
auth       include      postlogin
account    required     pam_nologin.so
account    include      system-auth
password   include      system-auth
session    required     pam_selinux.so close
session    required     pam_loginuid.so
session    optional     pam_console.so
session    required     pam_selinux.so open
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    include      system-auth
session    include      postlogin
-session   optional     pam_ck_connector.so
session required pam_limits.so
session required /lib64/security/pam_limits.so

#==============================================================#                                                                                  
禁用 RemoveIPC                                                                                      
#==============================================================#                                                                                  

[Login]
RemoveIPC=no

#==============================================================#                                                                                  
配置语言中文                                                                                    
#==============================================================#                                                                                  

export LANG=zh_CN.UTF-8

#==============================================================#                                                                                  
配置用户环境变量                                                                                  
#==============================================================#                                                                                  

if [ -f ~/.bashrc ]; then
	. ~/.bashrc
fi
PATH=$PATH:$HOME/.local/bin:$HOME/bin
export PATH
export MALLOC_ARENA_MAX=1
export DM_HOME=/opt/dmdbms
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin
export PATH=$PATH:$DM_HOME/bin:$DM_HOME/tool
export PS1="[`whoami`@`hostname`:"'\w]$ '
alias ds='disql SYSDBA/SYSDBA:5236 '
alias dsql='disql SYSDBA/SYSDBA:5236  \`'
alias dssql='disql -S SYSDBA/SYSDBA:5236  \`'
alias dmlog='cd $DM_HOME/log'

#==============================================================#                                                                                  
挂载达梦安装镜像                                                                                  
#==============================================================#                                                                                  

总用量 959M
-r-xr-xr-x. 1 root root 2.7M 11月 21 16:25 DM8 Install.pdf
-r-xr-xr-x. 1 root root 957M 11月 21 16:27 DMInstall.bin

#==============================================================#                                                                                  
安装达梦数据库软件                                                                                  
#==============================================================#                                                                                  

解压安装程序......... 
2022-12-20 17:26:11 
[INFO] 安装达梦数据库...
2022-12-20 17:26:11 
[INFO] 安装 基础 模块...
2022-12-20 17:26:16 
[INFO] 安装 服务器 模块...
2022-12-20 17:26:17 
[INFO] 安装 客户端 模块...
2022-12-20 17:26:21 
[INFO] 安装 驱动 模块...
2022-12-20 17:26:23 
[INFO] 安装 手册 模块...
2022-12-20 17:26:23 
[INFO] 安装 服务 模块...
2022-12-20 17:26:25 
[INFO] 移动日志文件。
2022-12-20 17:26:25 
[INFO] 更改安装目录权限完成。
2022-12-20 17:26:25 
[INFO] 正在启动DmAPService服务...
2022-12-20 17:26:26 
[INFO] 启动DmAPService服务成功。
2022-12-20 17:26:26 
[INFO] 安装达梦数据库完成。

#==============================================================#                                                                                  
初始化达梦数据库                                                                                  
#==============================================================#                                                                                  

initdb V8
db version: 0x7000c
file dm.key not found, use default license!
License will expire on 2023-11-21
Normal of FAST
Normal of DEFAULT
Normal of RECYCLE
Normal of KEEP
Normal of ROLL

 log file path: /dmdata/DAMENG/DAMENG01.log


 log file path: /dmdata/DAMENG/DAMENG02.log

write to dir [/dmdata/DAMENG].
create dm database success. 2022-12-20 17:26:32

#==============================================================#                                                                                  
注册实例服务                                                                                    
#==============================================================#                                                                                  

Created symlink from /etc/systemd/system/multi-user.target.wants/DmServiceDAMENG.service to /usr/lib/systemd/system/DmServiceDAMENG.service.
创建服务(DmServiceDAMENG)完成

#==============================================================#                                                                                  
启停数据库                                                                                       
#==============================================================#                                                                                  


后台启动数据库：                                                                                  

Starting DmServiceDAMENG:                                  [ OK ]
DmServiceDAMENG (pid 5209) is running.

查询数据库基础参数信息：                                                                                  

密钥过期时间：2023-11-21

数据库参数项              数据库参数值                 
------------------------------- -----------------------------------
实例名                       GRP1_DW_01
DM Database Server x64 V8       --03134283950-20221121-175072-20024
簇大小                       32
页大小                       32
大小写敏感                 1
字符集                       1
varchar是否以字符为单位 0

#==============================================================#                                                                                  
创建归档和备份脚本                                                                                  
#==============================================================#                                                                                  

创建数据库归档脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 378 12月 20 17:26 /home/dmdba/scripts/conf_arch.sql

创建数据库备份脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 780 12月 20 17:26 /home/dmdba/scripts/conf_fullbackup.sql
-rw-r--r--. 1 dmdba dinstall 1.5K 12月 20 17:26 /home/dmdba/scripts/conf_incrbackup.sql

创建 DMDBA 用户脚本，密码 SYSDBA ：                                                                                  

-rw-r--r--. 1 dmdba dinstall 696 12月 20 17:26 /home/dmdba/scripts/ct_dbuser.sql

#==============================================================#                                                                                  
创建达梦数据库优化脚本                                                                                  
#==============================================================#                                                                                  

创建数据库参数配置脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 14K 12月 20 17:26 /home/dmdba/scripts/conf_para.sql

创建数据库优化结果查询脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 2.2K 12月 20 17:26 /home/dmdba/scripts/query_dm.sql

#==============================================================#                                                                                  
在 192.168.2.26 创建备份                                                                                  
#==============================================================#                                                                                  

密钥过期时间：2023-11-21

NAME     DESCRIBE                                                                       
-------- -------------------------------------------------------------------------------
bak_full 周六全量备份，并删除30天之前的备份。
bak_inc  周日到周五做增量备份,如果失败,清除8天前备份,做全量备份

NAME      COMMAND                                                                                                  
--------- ---------------------------------------------------------------------------------------------------------
bak_clear CALL SF_BAKSET_BACKUP_DIR_ADD('DISK','/dmbak/DAMENG'); CALL SP_DB_BAKSET_REMOVE_BATCH('DISK',SYSDATE-30);

#==============================================================#                                                                                  
优化数据库基础参数                                                                                  
#==============================================================#                                                                                  

密钥过期时间：2023-11-21

修改cpu相关参数: 
 
SP_SET_PARA_VALUE(2,'WORKER_THREADS',1);
SP_SET_PARA_VALUE(2,'TASK_THREADS',4);
SP_SET_PARA_VALUE(2,'IO_THR_GROUPS',2);

修改内存池相关参数: 
 
SP_SET_PARA_VALUE(2,'MAX_OS_MEMORY',80);
SP_SET_PARA_VALUE(2,'MEMORY_POOL',100);
SP_SET_PARA_VALUE(2,'MEMORY_N_POOLS',1);
SP_SET_PARA_VALUE(2,'MEMORY_TARGET',0);

修改缓冲区相关参数: 
 
SP_SET_PARA_VALUE(2,'BUFFER',1000);
SP_SET_PARA_VALUE(2,'MAX_BUFFER',1000);
SP_SET_PARA_VALUE(2,'BUFFER_POOLS',3);
SP_SET_PARA_VALUE(2,'RECYCLE',80);
SP_SET_PARA_VALUE(2,'RECYCLE_POOLS',2);

修改fast_pool相关参数: 
 
SP_SET_PARA_VALUE(2,'FAST_POOL_PAGES',3000);
SP_SET_PARA_VALUE(2,'FAST_ROLL_PAGES',1000);

修改内存检测参数为1: 
 
SP_SET_PARA_VALUE(2,'MEMORY_MAGIC_CHECK',1);

非DSC环境将ENABLE_FREQROOTS设置为1,注意DM7 V$instance视图没有dsc_role字段,DM7这部分可以删掉: 
 
SP_SET_PARA_VALUE(2,'ENABLE_FREQROOTS',1);

修改HASH相关参数: 
 
SP_SET_PARA_VALUE(1,'HJ_BUF_GLOBAL_SIZE',500);
SP_SET_PARA_VALUE(1,'HJ_BUF_SIZE',50);
SP_SET_PARA_VALUE(1,'HAGR_BUF_GLOBAL_SIZE',500);
SP_SET_PARA_VALUE(1,'HAGR_BUF_SIZE',50);

修改排序相关参数: 
 
SP_SET_PARA_VALUE(2,'SORT_FLAG',0);
SP_SET_PARA_VALUE(2,'SORT_BLK_SIZE',1);
SP_SET_PARA_VALUE(2,'SORT_BUF_SIZE',10);
SP_SET_PARA_VALUE(2,'SORT_BUF_GLOBAL_SIZE',500);

修改其他内存参数: 
 
SP_SET_PARA_VALUE(2,'RLOG_POOL_SIZE',256);
SP_SET_PARA_VALUE(2,'CACHE_POOL_SIZE',200);
SP_SET_PARA_VALUE(2,'DICT_BUF_SIZE',50);
SP_SET_PARA_VALUE(2,'VM_POOL_TARGET',16384);
SP_SET_PARA_VALUE(2,'SESS_POOL_TARGET',16384);

修改实例相关参数: 
 
SP_SET_PARA_VALUE(2,'USE_PLN_POOL',1);
SP_SET_PARA_VALUE(2,'ENABLE_MONITOR',1);
SP_SET_PARA_VALUE(2,'TEMP_SIZE',1024);
SP_SET_PARA_VALUE(2,'TEMP_SPACE_LIMIT',102400);
SP_SET_PARA_VALUE(2,'MAX_SESSIONS',1500);
SP_SET_PARA_VALUE(2,'MAX_SESSION_STATEMENT',20000);
SP_SET_PARA_VALUE(2,'PK_WITH_CLUSTER',0);
SP_SET_PARA_VALUE(2,'ENABLE_ENCRYPT',0);

修改优化器相关参数: 
 
SP_SET_PARA_VALUE(2,'OLAP_FLAG',2);
SP_SET_PARA_VALUE(2,'VIEW_PULLUP_FLAG',1);
SP_SET_PARA_VALUE(2,'OPTIMIZER_MODE',1);
SP_SET_PARA_VALUE(2,'ADAPTIVE_NPLN_FLAG',0);

开启并行PURGE: 
 
SP_SET_PARA_VALUE(2,'PARALLEL_PURGE_FLAG',1);

开启手动并行: 
 
SP_SET_PARA_VALUE(2,'PARALLEL_POLICY',2);

UNDO_RETENTION如果放大，可以适当调大UNDO_EXTENT_NUM。负载高的时候，减少文件系统的申请/释放操作: 
 
SP_SET_PARA_VALUE(2,'UNDO_EXTENT_NUM',16);

开启SQL 注入HINT功能: 
 
SP_SET_PARA_VALUE(2,'ENABLE_INJECT_HINT',1);

开启数据异步追踪: 
 
SP_SET_PARA_VALUE(1,'SVR_LOG',1);

开启操作系统认证: 
 
sp_set_para_value(2,'ENABLE_LOCAL_OSAUTH',1);



重启数据库，优化参数生效                                                                                  

Stopping DmServiceDAMENG:                                  [ OK ]
Starting DmServiceDAMENG:                                  [ OK ]

#==============================================================#                                                                                  
创建DMDBA用户，密码：SYSDBA                                                                                  
#==============================================================#                                                                                  

密钥过期时间：2023-11-21

USERNAME  
----------
SYSAUDITOR
SYSSSO
SYSDBA
DMDBA
SYS

#==============================================================#                                                                                  
查询数据库优化结果：                                                                                  
#==============================================================#                                                                                  

密钥过期时间：2023-11-21

PARA_NAME             DEFAULT_VALUE PARA_VALUE
--------------------- ------------- ----------
MAX_OS_MEMORY         100           80
MAX_SESSION_STATEMENT 10000         20000
TRX_VIEW_MODE         1             1
MAX_SESSIONS          10000         1500
IO_THR_GROUPS         8             2
ADAPTIVE_NPLN_FLAG    3             0
OPTIMIZER_MODE        1             1
TOP_DIS_HASH_FLAG     1             1
TOP_ORDER_OPT_FLAG    0             0
VIEW_PULLUP_FLAG      0             1
USE_PLN_POOL          1             1
TASK_THREADS          16            4
WORKER_THREADS        16            1
SESS_POOL_TARGET      16384         16384
SESS_POOL_SIZE        64            64
VM_POOL_TARGET        16384         16384
DICT_BUF_SIZE         50            50
HAGR_BUF_SIZE         500           50
HAGR_BUF_GLOBAL_SIZE  5000          1000
HJ_BUF_SIZE           500           50
HJ_BUF_GLOBAL_SIZE    5000          1000
SORT_FLAG             0             0
SORT_BUF_GLOBAL_SIZE  1000          500
SORT_BLK_SIZE         1             1
SORT_BUF_SIZE         20            10
MAX_BUFFER            1000          1000
RECYCLE_POOLS         3             1
RECYCLE               300           80
BUFFER_POOLS          9             3
BUFFER                1000          1000
MEMORY_MAGIC_CHECK    1             1
MEMORY_TARGET         15000         0
MEMORY_N_POOLS        1             1
MEMORY_POOL           500           100
PK_WITH_CLUSTER       0             0
ENABLE_MONITOR        1             1
SVR_LOG               0             1
DATETIME_FMT_MODE     0             0
COMPATIBLE_MODE       0             0
CLOB_LIKE_MAX_LEN     10240         10240
ENABLE_ENCRYPT        0             0
REDOS_PARALLEL_NUM    1             1
RLOG_POOL_SIZE        256           256
CACHE_POOL_SIZE       100           200
TEMP_SPACE_LIMIT      0             102400
TEMP_SIZE             10            1024
OLAP_FLAG             2             2

#==============================================================#                                                                                  
数据守护主库脱机备份                                                                                  
#==============================================================#                                                                                  

正常关闭主数据库：                                                                                  

Stopping DmServiceDAMENG:                                  [ OK ]

主库进行脱机 dmrman 备份：                                                                                  

dmrman V8
BACKUP DATABASE '/dmdata/DAMENG/dm.ini' FULL TO BACKUP_FILE1 BACKUPSET '/dmbak/BACKUP_FILE_01'
file dm.key not found, use default license!
Database mode = 0, oguid = 0
Normal of FAST
Normal of DEFAULT
Normal of RECYCLE
Normal of KEEP
Normal of ROLL
EP[0]'s cur_lsn[39191], file_lsn[39191]
Processing backupset /dmbak/BACKUP_FILE_01
[Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 
backup successfully!
time used: 00:00:03.246

主库查看脱机备份文件：                                                                                  

总用量 22596
drwxr-xr-x. 2 dmdba dinstall       59 12月 20 17:27 .
drwxrwxr-x. 4 dmdba dinstall       42 12月 20 17:27 ..
-rw-r--r--. 1 dmdba dinstall 23042048 12月 20 17:27 BACKUP_FILE_01.bak
-rw-r--r--. 1 dmdba dinstall    91648 12月 20 17:27 BACKUP_FILE_01.meta

#==============================================================#                                                                                  
配置节点：192.168.2.27                                                                                  
#==============================================================#                                                                                  


节点 192.168.2.27 开始执行配置：                                                                                  


 ███████   ████     ████  ████████ ██               ██  ██ ██                    ██              ██  ██
░██░░░░██ ░██░██   ██░██ ██░░░░░░ ░██              ░██ ░██░██                   ░██             ░██ ░██
░██    ░██░██░░██ ██ ░██░██       ░██       █████  ░██ ░██░██ ███████   ██████ ██████  ██████   ░██ ░██
░██    ░██░██ ░░███  ░██░█████████░██████  ██░░░██ ░██ ░██░██░░██░░░██ ██░░░░ ░░░██░  ░░░░░░██  ░██ ░██
░██    ░██░██  ░░█   ░██░░░░░░░░██░██░░░██░███████ ░██ ░██░██ ░██  ░██░░█████   ░██    ███████  ░██ ░██
░██    ██ ░██   ░    ░██       ░██░██  ░██░██░░░░  ░██ ░██░██ ░██  ░██ ░░░░░██  ░██   ██░░░░██  ░██ ░██
░███████  ░██        ░██ ████████ ░██  ░██░░██████ ███ ███░██ ███  ░██ ██████   ░░██ ░░████████ ███ ███
░░░░░░░   ░░         ░░ ░░░░░░░░  ░░   ░░  ░░░░░░ ░░░ ░░░ ░░ ░░░   ░░ ░░░░░░     ░░   ░░░░░░░░ ░░░ ░░░ 

达梦数据库开始安装：                                                                                  

#==============================================================#                                                                                  
打印系统信息                                                                                    
#==============================================================#                                                                                  

服务器时间:                                                                                      

2022年 12月 20日 星期二 17:28:23 CST

操作系统版本:                                                                                   

NAME="CentOS Linux"
VERSION="7 (Core)"
ID="centos"
ID_LIKE="rhel fedora"
VERSION_ID="7"
PRETTY_NAME="CentOS Linux 7 (Core)"
ANSI_COLOR="0;31"
CPE_NAME="cpe:/o:centos:centos:7"
HOME_URL="https://www.centos.org/"
BUG_REPORT_URL="https://bugs.centos.org/"

CENTOS_MANTISBT_PROJECT="CentOS-7"
CENTOS_MANTISBT_PROJECT_VERSION="7"
REDHAT_SUPPORT_PRODUCT="centos"
REDHAT_SUPPORT_PRODUCT_VERSION="7"


cpu信息:                                                                                            

Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                1
On-line CPU(s) list:   0
Thread(s) per core:    1
Core(s) per socket:    1
座：                 1
NUMA 节点：         1
厂商 ID：           GenuineIntel
CPU 系列：          6
型号：              142
型号名称：        Intel(R) Core(TM) i7-8565U CPU @ 1.80GHz
步进：              12
CPU MHz：             1992.001
BogoMIPS：            3984.00
超管理器厂商：  VMware
虚拟化类型：     完全
L1d 缓存：          32K
L1i 缓存：          32K
L2 缓存：           256K
L3 缓存：           8192K
NUMA 节点0 CPU：    0
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single ssbd ibrs ibpb stibp ibrs_enhanced fsgsbase tsc_adjust bmi1 avx2 smep bmi2 invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 arat md_clear spec_ctrl intel_stibp flush_l1d arch_capabilities

内存信息:                                                                                         

              total        used        free      shared  buff/cache   available
Mem:           2827         256        1447           9        1123        2405
Swap:          8191           0        8191
              total        used        free      shared  buff/cache   available
Mem:           2.8G        256M        1.4G        9.4M        1.1G        2.3G
Swap:          8.0G          0B        8.0G

挂载信息:                                                                                         

/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=dc24af02-0269-4d90-88b9-c6fdb8c27470 /boot                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0
/dev/sr0                /mnt/cdrom              iso9660 defaults        0 0

目录信息:                                                                                         

文件系统                 容量  已用  可用 已用% 挂载点
devtmpfs                 1.4G     0  1.4G    0% /dev
tmpfs                    1.4G     0  1.4G    0% /dev/shm
tmpfs                    1.4G  9.5M  1.4G    1% /run
tmpfs                    1.4G     0  1.4G    0% /sys/fs/cgroup
/dev/mapper/centos-root   91G  2.7G   89G    3% /
/dev/sr0                 4.4G  4.4G     0  100% /mnt/cdrom
/dev/sda1               1014M  151M  864M   15% /boot
tmpfs                    283M     0  283M    0% /run/user/0

#==============================================================#                                                                                  
关闭 SWAP 功能                                                                                    
#==============================================================#                                                                                  

              total        used        free      shared  buff/cache   available
Mem:        2895196      256256     1488816        9672     1150124     2470088
Swap:             0           0           0

#/dev/mapper/centos-swap swap                    swap    defaults        0 0

#==============================================================#                                                                                  
禁用防火墙                                                                                       
#==============================================================#                                                                                  

● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)

12月 20 17:24:21 centos7 systemd[1]: Starting firewalld - dynamic firewall daemon...
12月 20 17:24:22 centos7 systemd[1]: Started firewalld - dynamic firewall daemon.
12月 20 17:24:22 centos7 firewalld[784]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure configuration option. It will be removed in a future release. Please consider disabling it now.
12月 20 17:28:23 centos7 systemd[1]: Stopping firewalld - dynamic firewall daemon...
12月 20 17:28:24 centos7 systemd[1]: Stopped firewalld - dynamic firewall daemon.

#==============================================================#                                                                                  
禁用 selinux                                                                                        
#==============================================================#                                                                                  

SELINUX=disabled
SELINUXTYPE=targeted 

#==============================================================#                                                                                  
配置主机名                                                                                       
#==============================================================#                                                                                  

   Static hostname: dw02
         Icon name: computer-vm
           Chassis: vm
        Machine ID: f4a41440d98d417dbb5516d46b966467
           Boot ID: dbf0e87b10dd4f3a93d4e168ec9aecb8
    Virtualization: vmware
  Operating System: CentOS Linux 7 (Core)
       CPE OS Name: cpe:/o:centos:centos:7
            Kernel: Linux 3.10.0-1160.el7.x86_64
      Architecture: x86-64

#==============================================================#                                                                                  
配置时间同步                                                                                    
#==============================================================#                                                                                  

Removed symlink /etc/systemd/system/multi-user.target.wants/chronyd.service.
● chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:chronyd(8)
           man:chrony.conf(5)

12月 20 17:24:21 centos7 systemd[1]: Starting NTP client/server...
12月 20 17:24:21 centos7 chronyd[754]: chronyd version 3.4 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +SECHASH +IPV6 +DEBUG)
12月 20 17:24:21 centos7 chronyd[754]: Frequency 0.000 +/- 1000000.000 ppm read from /var/lib/chrony/drift
12月 20 17:24:21 centos7 systemd[1]: Started NTP client/server.
12月 20 17:28:24 dw02 systemd[1]: Stopping NTP client/server...
12月 20 17:28:24 dw02 systemd[1]: Stopped NTP client/server.
2022年 12月 20日 星期二 17:28:24 CST

no crontab for root

#==============================================================#                                                                                  
禁用透明大页 & 禁用NUMA & 开启 I/0 schedule                                                                                  
#==============================================================#                                                                                  

index=0
kernel=/boot/vmlinuz-3.10.0-1160.el7.x86_64
args="ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet LANG=zh_CN.UTF-8 numa=off transparent_hugepage=never elevator=deadline"
--
index=1
kernel=/boot/vmlinuz-0-rescue-f4a41440d98d417dbb5516d46b966467
args="ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet numa=off transparent_hugepage=never elevator=deadline"

#==============================================================#                                                                                  
创建 DMDBA 用户以及安装目录                                                                                  
#==============================================================#                                                                                  

更改用户 dmdba 的密码 。
passwd：所有的身份验证令牌已经成功更新。

dmdba:x:54321:54321::/home/dmdba:/bin/bash

uid=54321(dmdba) gid=54321(dinstall) 组=54321(dinstall),54322(dmdba)

#==============================================================#                                                                                  
配置系统参数                                                                                    
#==============================================================#                                                                                  

fs.aio-max-nr = 1048576
fs.file-max = 6815744
kernel.shmmni = 4096
kernel.sem = 250 32000 100 128
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
vm.swappiness = 0
vm.dirty_background_ratio = 3
vm.dirty_ratio = 80
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100
sysctl: cannot stat /proc/sys/vm/numa_stat: 没有那个文件或目录
vm.overcommit_memory = 0

#==============================================================#                                                                                  
配置用户限制                                                                                    
#==============================================================#                                                                                  

dmdba - nice   0
dmdba - as     unlimited
dmdba - fsize  unlimited
dmdba - nproc  131072
dmdba - nofile 131072
dmdba - core   unlimited
dmdba - data   unlimited
root  - nice   0
root  - as     unlimited
root  - fsize  unlimited
root  - nproc  131072
root  - nofile 131072
root  - core   unlimited
root  - data   unlimited

[Manager]
DefaultLimitCORE=infinity
DefaultLimitNOFILE=65536
DefaultLimitNPROC=10240

auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_securetty.so
auth       substack     system-auth
auth       include      postlogin
account    required     pam_nologin.so
account    include      system-auth
password   include      system-auth
session    required     pam_selinux.so close
session    required     pam_loginuid.so
session    optional     pam_console.so
session    required     pam_selinux.so open
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    include      system-auth
session    include      postlogin
-session   optional     pam_ck_connector.so
session required pam_limits.so
session required /lib64/security/pam_limits.so

#==============================================================#                                                                                  
禁用 RemoveIPC                                                                                      
#==============================================================#                                                                                  

[Login]
RemoveIPC=no

#==============================================================#                                                                                  
配置语言中文                                                                                    
#==============================================================#                                                                                  

export LANG=zh_CN.UTF-8

#==============================================================#                                                                                  
配置用户环境变量                                                                                  
#==============================================================#                                                                                  

if [ -f ~/.bashrc ]; then
	. ~/.bashrc
fi
PATH=$PATH:$HOME/.local/bin:$HOME/bin
export PATH
export MALLOC_ARENA_MAX=1
export DM_HOME=/opt/dmdbms
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin
export PATH=$PATH:$DM_HOME/bin:$DM_HOME/tool
export PS1="[`whoami`@`hostname`:"'\w]$ '
alias ds='disql SYSDBA/SYSDBA:5236 '
alias dsql='disql SYSDBA/SYSDBA:5236  \`'
alias dssql='disql -S SYSDBA/SYSDBA:5236  \`'
alias dmlog='cd $DM_HOME/log'

#==============================================================#                                                                                  
挂载达梦安装镜像                                                                                  
#==============================================================#                                                                                  

总用量 959M
-r-xr-xr-x. 1 root root 2.7M 11月 21 16:25 DM8 Install.pdf
-r-xr-xr-x. 1 root root 957M 11月 21 16:27 DMInstall.bin

#==============================================================#                                                                                  
安装达梦数据库软件                                                                                  
#==============================================================#                                                                                  

解压安装程序......... 
2022-12-20 17:28:54 
[INFO] 安装达梦数据库...
2022-12-20 17:28:55 
[INFO] 安装 基础 模块...
2022-12-20 17:28:59 
[INFO] 安装 服务器 模块...
2022-12-20 17:29:00 
[INFO] 安装 客户端 模块...
2022-12-20 17:29:03 
[INFO] 安装 驱动 模块...
2022-12-20 17:29:05 
[INFO] 安装 手册 模块...
2022-12-20 17:29:06 
[INFO] 安装 服务 模块...
2022-12-20 17:29:08 
[INFO] 移动日志文件。
2022-12-20 17:29:08 
[INFO] 更改安装目录权限完成。
2022-12-20 17:29:08 
[INFO] 正在启动DmAPService服务...
2022-12-20 17:29:09 
[INFO] 启动DmAPService服务成功。
2022-12-20 17:29:09 
[INFO] 安装达梦数据库完成。

#==============================================================#                                                                                  
初始化达梦数据库                                                                                  
#==============================================================#                                                                                  

initdb V8
db version: 0x7000c
file dm.key not found, use default license!
License will expire on 2023-11-21
Normal of FAST
Normal of DEFAULT
Normal of RECYCLE
Normal of KEEP
Normal of ROLL

 log file path: /dmdata/DAMENG/DAMENG01.log


 log file path: /dmdata/DAMENG/DAMENG02.log

write to dir [/dmdata/DAMENG].
create dm database success. 2022-12-20 17:29:15

#==============================================================#                                                                                  
注册实例服务                                                                                    
#==============================================================#                                                                                  

Created symlink from /etc/systemd/system/multi-user.target.wants/DmServiceDAMENG.service to /usr/lib/systemd/system/DmServiceDAMENG.service.
创建服务(DmServiceDAMENG)完成

#==============================================================#                                                                                  
启停数据库                                                                                       
#==============================================================#                                                                                  


后台启动数据库：                                                                                  

Starting DmServiceDAMENG:                                  [ OK ]
DmServiceDAMENG (pid 4949) is running.

查询数据库基础参数信息：                                                                                  

密钥过期时间：2023-11-21

数据库参数项              数据库参数值                 
------------------------------- -----------------------------------
实例名                       GRP1_DW_02
DM Database Server x64 V8       --03134283950-20221121-175072-20024
簇大小                       32
页大小                       32
大小写敏感                 1
字符集                       1
varchar是否以字符为单位 0

#==============================================================#                                                                                  
创建归档和备份脚本                                                                                  
#==============================================================#                                                                                  

创建数据库归档脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 378 12月 20 17:29 /home/dmdba/scripts/conf_arch.sql

创建数据库备份脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 780 12月 20 17:29 /home/dmdba/scripts/conf_fullbackup.sql
-rw-r--r--. 1 dmdba dinstall 1.5K 12月 20 17:29 /home/dmdba/scripts/conf_incrbackup.sql

创建 DMDBA 用户脚本，密码 SYSDBA ：                                                                                  

-rw-r--r--. 1 dmdba dinstall 696 12月 20 17:29 /home/dmdba/scripts/ct_dbuser.sql

#==============================================================#                                                                                  
创建达梦数据库优化脚本                                                                                  
#==============================================================#                                                                                  

创建数据库参数配置脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 14K 12月 20 17:29 /home/dmdba/scripts/conf_para.sql

创建数据库优化结果查询脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 2.2K 12月 20 17:29 /home/dmdba/scripts/query_dm.sql

#==============================================================#                                                                                  
优化数据库基础参数                                                                                  
#==============================================================#                                                                                  

密钥过期时间：2023-11-21

修改cpu相关参数: 
 
SP_SET_PARA_VALUE(2,'WORKER_THREADS',1);
SP_SET_PARA_VALUE(2,'TASK_THREADS',4);
SP_SET_PARA_VALUE(2,'IO_THR_GROUPS',2);

修改内存池相关参数: 
 
SP_SET_PARA_VALUE(2,'MAX_OS_MEMORY',80);
SP_SET_PARA_VALUE(2,'MEMORY_POOL',100);
SP_SET_PARA_VALUE(2,'MEMORY_N_POOLS',1);
SP_SET_PARA_VALUE(2,'MEMORY_TARGET',0);

修改缓冲区相关参数: 
 
SP_SET_PARA_VALUE(2,'BUFFER',1000);
SP_SET_PARA_VALUE(2,'MAX_BUFFER',1000);
SP_SET_PARA_VALUE(2,'BUFFER_POOLS',3);
SP_SET_PARA_VALUE(2,'RECYCLE',80);
SP_SET_PARA_VALUE(2,'RECYCLE_POOLS',2);

修改fast_pool相关参数: 
 
SP_SET_PARA_VALUE(2,'FAST_POOL_PAGES',3000);
SP_SET_PARA_VALUE(2,'FAST_ROLL_PAGES',1000);

修改内存检测参数为1: 
 
SP_SET_PARA_VALUE(2,'MEMORY_MAGIC_CHECK',1);

非DSC环境将ENABLE_FREQROOTS设置为1,注意DM7 V$instance视图没有dsc_role字段,DM7这部分可以删掉: 
 
SP_SET_PARA_VALUE(2,'ENABLE_FREQROOTS',1);

修改HASH相关参数: 
 
SP_SET_PARA_VALUE(1,'HJ_BUF_GLOBAL_SIZE',500);
SP_SET_PARA_VALUE(1,'HJ_BUF_SIZE',50);
SP_SET_PARA_VALUE(1,'HAGR_BUF_GLOBAL_SIZE',500);
SP_SET_PARA_VALUE(1,'HAGR_BUF_SIZE',50);

修改排序相关参数: 
 
SP_SET_PARA_VALUE(2,'SORT_FLAG',0);
SP_SET_PARA_VALUE(2,'SORT_BLK_SIZE',1);
SP_SET_PARA_VALUE(2,'SORT_BUF_SIZE',10);
SP_SET_PARA_VALUE(2,'SORT_BUF_GLOBAL_SIZE',500);

修改其他内存参数: 
 
SP_SET_PARA_VALUE(2,'RLOG_POOL_SIZE',256);
SP_SET_PARA_VALUE(2,'CACHE_POOL_SIZE',200);
SP_SET_PARA_VALUE(2,'DICT_BUF_SIZE',50);
SP_SET_PARA_VALUE(2,'VM_POOL_TARGET',16384);
SP_SET_PARA_VALUE(2,'SESS_POOL_TARGET',16384);

修改实例相关参数: 
 
SP_SET_PARA_VALUE(2,'USE_PLN_POOL',1);
SP_SET_PARA_VALUE(2,'ENABLE_MONITOR',1);
SP_SET_PARA_VALUE(2,'TEMP_SIZE',1024);
SP_SET_PARA_VALUE(2,'TEMP_SPACE_LIMIT',102400);
SP_SET_PARA_VALUE(2,'MAX_SESSIONS',1500);
SP_SET_PARA_VALUE(2,'MAX_SESSION_STATEMENT',20000);
SP_SET_PARA_VALUE(2,'PK_WITH_CLUSTER',0);
SP_SET_PARA_VALUE(2,'ENABLE_ENCRYPT',0);

修改优化器相关参数: 
 
SP_SET_PARA_VALUE(2,'OLAP_FLAG',2);
SP_SET_PARA_VALUE(2,'VIEW_PULLUP_FLAG',1);
SP_SET_PARA_VALUE(2,'OPTIMIZER_MODE',1);
SP_SET_PARA_VALUE(2,'ADAPTIVE_NPLN_FLAG',0);

开启并行PURGE: 
 
SP_SET_PARA_VALUE(2,'PARALLEL_PURGE_FLAG',1);

开启手动并行: 
 
SP_SET_PARA_VALUE(2,'PARALLEL_POLICY',2);

UNDO_RETENTION如果放大，可以适当调大UNDO_EXTENT_NUM。负载高的时候，减少文件系统的申请/释放操作: 
 
SP_SET_PARA_VALUE(2,'UNDO_EXTENT_NUM',16);

开启SQL 注入HINT功能: 
 
SP_SET_PARA_VALUE(2,'ENABLE_INJECT_HINT',1);

开启数据异步追踪: 
 
SP_SET_PARA_VALUE(1,'SVR_LOG',1);

开启操作系统认证: 
 
sp_set_para_value(2,'ENABLE_LOCAL_OSAUTH',1);



重启数据库，优化参数生效                                                                                  

Stopping DmServiceDAMENG:                                  [ OK ]
Starting DmServiceDAMENG:                                  [ OK ]

#==============================================================#                                                                                  
查询数据库优化结果：                                                                                  
#==============================================================#                                                                                  

密钥过期时间：2023-11-21

PARA_NAME             DEFAULT_VALUE PARA_VALUE
--------------------- ------------- ----------
MAX_OS_MEMORY         100           80
MAX_SESSION_STATEMENT 10000         20000
TRX_VIEW_MODE         1             1
MAX_SESSIONS          10000         1500
IO_THR_GROUPS         8             2
ADAPTIVE_NPLN_FLAG    3             0
OPTIMIZER_MODE        1             1
TOP_DIS_HASH_FLAG     1             1
TOP_ORDER_OPT_FLAG    0             0
VIEW_PULLUP_FLAG      0             1
USE_PLN_POOL          1             1
TASK_THREADS          16            4
WORKER_THREADS        16            1
SESS_POOL_TARGET      16384         16384
SESS_POOL_SIZE        64            64
VM_POOL_TARGET        16384         16384
DICT_BUF_SIZE         50            50
HAGR_BUF_SIZE         500           50
HAGR_BUF_GLOBAL_SIZE  5000          1000
HJ_BUF_SIZE           500           50
HJ_BUF_GLOBAL_SIZE    5000          1000
SORT_FLAG             0             0
SORT_BUF_GLOBAL_SIZE  1000          500
SORT_BLK_SIZE         1             1
SORT_BUF_SIZE         20            10
MAX_BUFFER            1000          1000
RECYCLE_POOLS         3             1
RECYCLE               300           80
BUFFER_POOLS          9             3
BUFFER                1000          1000
MEMORY_MAGIC_CHECK    1             1
MEMORY_TARGET         15000         0
MEMORY_N_POOLS        1             1
MEMORY_POOL           500           100
PK_WITH_CLUSTER       0             0
ENABLE_MONITOR        1             1
SVR_LOG               0             1
DATETIME_FMT_MODE     0             0
COMPATIBLE_MODE       0             0
CLOB_LIKE_MAX_LEN     10240         10240
ENABLE_ENCRYPT        0             0
REDOS_PARALLEL_NUM    1             1
RLOG_POOL_SIZE        256           256
CACHE_POOL_SIZE       100           200
TEMP_SPACE_LIMIT      0             102400
TEMP_SIZE             10            1024
OLAP_FLAG             2             2

#==============================================================#                                                                                  
数据守护备库脱机恢复                                                                                  
#==============================================================#                                                                                  

正常关闭备数据库：                                                                                  

Stopping DmServiceDAMENG:                                  [ OK ]

拷贝主库的备份文件并授权：                                                                                  

BACKUP_FILE_01.bak                                                                                                                                                                 100%   22MB  96.8MB/s   00:00    
BACKUP_FILE_01.meta                                                                                                                                                                100%   90KB  45.3MB/s   00:00    

备库执行脱机数据库 dmrman 还原：                                                                                  

dmrman V8
RESTORE DATABASE '/dmdata/DAMENG/dm.ini' FROM BACKUPSET '/dmbak/BACKUP_FILE_01'
file dm.key not found, use default license!
Normal of FAST
Normal of DEFAULT
Normal of RECYCLE
Normal of KEEP
Normal of ROLL
[Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 
restore successfully.
time used: 00:00:02.463

备库执行 dmrman 数据库更新：                                                                                  

dmrman V8
RECOVER DATABASE '/dmdata/DAMENG/dm.ini' UPDATE DB_MAGIC
file dm.key not found, use default license!
Database mode = 2, oguid = 0
Normal of FAST
Normal of DEFAULT
Normal of RECYCLE
Normal of KEEP
Normal of ROLL
EP[0]'s cur_lsn[39191], file_lsn[39191]
recover successfully!
time used: 998.344(ms)

#==============================================================#                                                                                  
数据守护主备配置参数文件                                                                                  
#==============================================================#                                                                                  

备库配置 dm.ini 参数：                                                                                  

		ALTER_MODE_STATUS               = 1                     #Whether to permit database user to alter database mode and status by SQLs, 1: yes, 0: no
		ENABLE_OFFLINE_TS               = 2                     #Whether tablespace can be offline
		MAL_INI                         = 1                     #dmmal.ini
		ARCH_INI                        = 1                     #dmarch.ini

备库配置 dmmal.ini 参数：                                                                                  

MAL_CHECK_INTERVAL = 5
MAL_CONN_FAIL_INTERVAL = 5

[MAL_INST1]
MAL_INST_NAME = GRP1_DW_01
MAL_HOST = 172.16.2.26
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.26
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

[MAL_INST2]
MAL_INST_NAME = GRP1_DW_02
MAL_HOST = 172.16.2.27
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.27
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

[MAL_INST3]
MAL_INST_NAME = GRP1_DW_03
MAL_HOST = 172.16.2.28
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.28
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

备库配置 dmarch.ini 参数：                                                                                  

ARCH_WAIT_APPLY = 1

[ARCHIVE_LOCAL1]
        ARCH_TYPE            = LOCAL
        ARCH_DEST            = /dmarch/DAMENG
        ARCH_FILE_SIZE       = 1024
        ARCH_SPACE_LIMIT     = 102400

[ARCHIVE_REALTIME1]
ARCH_TYPE = REALTIME
ARCH_DEST = GRP1_DW_01

[ARCHIVE_REALTIME2]
ARCH_TYPE = REALTIME
ARCH_DEST = GRP1_DW_03

备库配置 dmwatcher.ini 参数：                                                                                  

[GRP1]
DW_TYPE = GLOBAL
DW_MODE = AUTO
DW_ERROR_TIME = 10
INST_ERROR_TIME = 10
INST_OGUID = 498860
INST_INI = /dmdata/DAMENG/dm.ini
INST_AUTO_RESTART = 1
INST_STARTUP_CMD = /opt/dmdbms/bin/DmServiceDAMENG start

备库配置 dmmonitor.ini 参数：                                                                                  

MON_DW_CONFIRM = 0
MON_LOG_PATH = /opt/dmdbms/log
MON_LOG_INTERVAL = 60
MON_LOG_FILE_SIZE = 32
MON_LOG_SPACE_LIMIT = 2048

[GRP1]
MON_INST_OGUID = 498860
MON_DW_IP = 172.16.2.26:12346
MON_DW_IP = 172.16.2.27:12346
MON_DW_IP = 172.16.2.28:12346

备库注册 dmwatcher 服务：                                                                                  

Created symlink from /etc/systemd/system/multi-user.target.wants/DmWatcherServiceGRP1.service to /usr/lib/systemd/system/DmWatcherServiceGRP1.service.
创建服务(DmWatcherServiceGRP1)完成

备库启动到 mount 状态：                                                                                  

Starting DmServiceDAMENG:                                  [ OK ]

备库修改模式：                                                                                  

密钥过期时间：2023-11-21

备库启动守护进程：                                                                                  

Starting DmWatcherServiceGRP1:                             [ OK ]


Connection to 192.168.2.27 closed.

节点 192.168.2.27 配置完成！                                                                                  

#==============================================================#                                                                                  
配置节点：192.168.2.28                                                                                  
#==============================================================#                                                                                  


节点 192.168.2.28 开始执行配置：                                                                                  


 ███████   ████     ████  ████████ ██               ██  ██ ██                    ██              ██  ██
░██░░░░██ ░██░██   ██░██ ██░░░░░░ ░██              ░██ ░██░██                   ░██             ░██ ░██
░██    ░██░██░░██ ██ ░██░██       ░██       █████  ░██ ░██░██ ███████   ██████ ██████  ██████   ░██ ░██
░██    ░██░██ ░░███  ░██░█████████░██████  ██░░░██ ░██ ░██░██░░██░░░██ ██░░░░ ░░░██░  ░░░░░░██  ░██ ░██
░██    ░██░██  ░░█   ░██░░░░░░░░██░██░░░██░███████ ░██ ░██░██ ░██  ░██░░█████   ░██    ███████  ░██ ░██
░██    ██ ░██   ░    ░██       ░██░██  ░██░██░░░░  ░██ ░██░██ ░██  ░██ ░░░░░██  ░██   ██░░░░██  ░██ ░██
░███████  ░██        ░██ ████████ ░██  ░██░░██████ ███ ███░██ ███  ░██ ██████   ░░██ ░░████████ ███ ███
░░░░░░░   ░░         ░░ ░░░░░░░░  ░░   ░░  ░░░░░░ ░░░ ░░░ ░░ ░░░   ░░ ░░░░░░     ░░   ░░░░░░░░ ░░░ ░░░ 

达梦数据库开始安装：                                                                                  

#==============================================================#                                                                                  
打印系统信息                                                                                    
#==============================================================#                                                                                  

服务器时间:                                                                                      

2022年 12月 20日 星期二 17:32:11 CST

操作系统版本:                                                                                   

NAME="CentOS Linux"
VERSION="7 (Core)"
ID="centos"
ID_LIKE="rhel fedora"
VERSION_ID="7"
PRETTY_NAME="CentOS Linux 7 (Core)"
ANSI_COLOR="0;31"
CPE_NAME="cpe:/o:centos:centos:7"
HOME_URL="https://www.centos.org/"
BUG_REPORT_URL="https://bugs.centos.org/"

CENTOS_MANTISBT_PROJECT="CentOS-7"
CENTOS_MANTISBT_PROJECT_VERSION="7"
REDHAT_SUPPORT_PRODUCT="centos"
REDHAT_SUPPORT_PRODUCT_VERSION="7"


cpu信息:                                                                                            

Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                1
On-line CPU(s) list:   0
Thread(s) per core:    1
Core(s) per socket:    1
座：                 1
NUMA 节点：         1
厂商 ID：           GenuineIntel
CPU 系列：          6
型号：              142
型号名称：        Intel(R) Core(TM) i7-8565U CPU @ 1.80GHz
步进：              12
CPU MHz：             1992.001
BogoMIPS：            3984.00
超管理器厂商：  VMware
虚拟化类型：     完全
L1d 缓存：          32K
L1i 缓存：          32K
L2 缓存：           256K
L3 缓存：           8192K
NUMA 节点0 CPU：    0
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single ssbd ibrs ibpb stibp ibrs_enhanced fsgsbase tsc_adjust bmi1 avx2 smep bmi2 invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 arat md_clear spec_ctrl intel_stibp flush_l1d arch_capabilities

内存信息:                                                                                         

              total        used        free      shared  buff/cache   available
Mem:           2827         253        1451           9        1123        2409
Swap:          8191           0        8191
              total        used        free      shared  buff/cache   available
Mem:           2.8G        252M        1.4G        9.4M        1.1G        2.4G
Swap:          8.0G          0B        8.0G

挂载信息:                                                                                         

/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=dc24af02-0269-4d90-88b9-c6fdb8c27470 /boot                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0
/dev/sr0                /mnt/cdrom              iso9660 defaults        0 0

目录信息:                                                                                         

文件系统                 容量  已用  可用 已用% 挂载点
devtmpfs                 1.4G     0  1.4G    0% /dev
tmpfs                    1.4G     0  1.4G    0% /dev/shm
tmpfs                    1.4G  9.5M  1.4G    1% /run
tmpfs                    1.4G     0  1.4G    0% /sys/fs/cgroup
/dev/mapper/centos-root   91G  2.7G   89G    3% /
/dev/sr0                 4.4G  4.4G     0  100% /mnt/cdrom
/dev/sda1               1014M  151M  864M   15% /boot
tmpfs                    283M     0  283M    0% /run/user/0

#==============================================================#                                                                                  
关闭 SWAP 功能                                                                                    
#==============================================================#                                                                                  

              total        used        free      shared  buff/cache   available
Mem:        2895196      252296     1492768        9672     1150132     2474032
Swap:             0           0           0

#/dev/mapper/centos-swap swap                    swap    defaults        0 0

#==============================================================#                                                                                  
禁用防火墙                                                                                       
#==============================================================#                                                                                  

● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)

12月 20 17:25:56 centos7 systemd[1]: Starting firewalld - dynamic firewall daemon...
12月 20 17:25:57 centos7 systemd[1]: Started firewalld - dynamic firewall daemon.
12月 20 17:25:57 centos7 firewalld[780]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure configuration option. It will be removed in a future release. Please consider disabling it now.
12月 20 17:32:11 centos7 systemd[1]: Stopping firewalld - dynamic firewall daemon...
12月 20 17:32:12 centos7 systemd[1]: Stopped firewalld - dynamic firewall daemon.

#==============================================================#                                                                                  
禁用 selinux                                                                                        
#==============================================================#                                                                                  

SELINUX=disabled
SELINUXTYPE=targeted 

#==============================================================#                                                                                  
配置主机名                                                                                       
#==============================================================#                                                                                  

   Static hostname: dw03
         Icon name: computer-vm
           Chassis: vm
        Machine ID: f4a41440d98d417dbb5516d46b966467
           Boot ID: c2eace14caf24dbda22c63ea09d5d442
    Virtualization: vmware
  Operating System: CentOS Linux 7 (Core)
       CPE OS Name: cpe:/o:centos:centos:7
            Kernel: Linux 3.10.0-1160.el7.x86_64
      Architecture: x86-64

#==============================================================#                                                                                  
配置时间同步                                                                                    
#==============================================================#                                                                                  

Removed symlink /etc/systemd/system/multi-user.target.wants/chronyd.service.
● chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:chronyd(8)
           man:chrony.conf(5)

12月 20 17:25:56 centos7 systemd[1]: Starting NTP client/server...
12月 20 17:25:56 centos7 chronyd[751]: chronyd version 3.4 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +SECHASH +IPV6 +DEBUG)
12月 20 17:25:56 centos7 chronyd[751]: Frequency 0.000 +/- 1000000.000 ppm read from /var/lib/chrony/drift
12月 20 17:25:56 centos7 systemd[1]: Started NTP client/server.
12月 20 17:32:12 dw03 systemd[1]: Stopping NTP client/server...
12月 20 17:32:12 dw03 systemd[1]: Stopped NTP client/server.
2022年 12月 20日 星期二 17:32:12 CST

no crontab for root

#==============================================================#                                                                                  
禁用透明大页 & 禁用NUMA & 开启 I/0 schedule                                                                                  
#==============================================================#                                                                                  

index=0
kernel=/boot/vmlinuz-3.10.0-1160.el7.x86_64
args="ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet LANG=zh_CN.UTF-8 numa=off transparent_hugepage=never elevator=deadline"
--
index=1
kernel=/boot/vmlinuz-0-rescue-f4a41440d98d417dbb5516d46b966467
args="ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet numa=off transparent_hugepage=never elevator=deadline"

#==============================================================#                                                                                  
创建 DMDBA 用户以及安装目录                                                                                  
#==============================================================#                                                                                  

更改用户 dmdba 的密码 。
passwd：所有的身份验证令牌已经成功更新。

dmdba:x:54321:54321::/home/dmdba:/bin/bash

uid=54321(dmdba) gid=54321(dinstall) 组=54321(dinstall),54322(dmdba)

#==============================================================#                                                                                  
配置系统参数                                                                                    
#==============================================================#                                                                                  

fs.aio-max-nr = 1048576
fs.file-max = 6815744
kernel.shmmni = 4096
kernel.sem = 250 32000 100 128
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
vm.swappiness = 0
vm.dirty_background_ratio = 3
vm.dirty_ratio = 80
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100
sysctl: cannot stat /proc/sys/vm/numa_stat: 没有那个文件或目录
vm.overcommit_memory = 0

#==============================================================#                                                                                  
配置用户限制                                                                                    
#==============================================================#                                                                                  

dmdba - nice   0
dmdba - as     unlimited
dmdba - fsize  unlimited
dmdba - nproc  131072
dmdba - nofile 131072
dmdba - core   unlimited
dmdba - data   unlimited
root  - nice   0
root  - as     unlimited
root  - fsize  unlimited
root  - nproc  131072
root  - nofile 131072
root  - core   unlimited
root  - data   unlimited

[Manager]
DefaultLimitCORE=infinity
DefaultLimitNOFILE=65536
DefaultLimitNPROC=10240

auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_securetty.so
auth       substack     system-auth
auth       include      postlogin
account    required     pam_nologin.so
account    include      system-auth
password   include      system-auth
session    required     pam_selinux.so close
session    required     pam_loginuid.so
session    optional     pam_console.so
session    required     pam_selinux.so open
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    include      system-auth
session    include      postlogin
-session   optional     pam_ck_connector.so
session required pam_limits.so
session required /lib64/security/pam_limits.so

#==============================================================#                                                                                  
禁用 RemoveIPC                                                                                      
#==============================================================#                                                                                  

[Login]
RemoveIPC=no

#==============================================================#                                                                                  
配置语言中文                                                                                    
#==============================================================#                                                                                  

export LANG=zh_CN.UTF-8

#==============================================================#                                                                                  
配置用户环境变量                                                                                  
#==============================================================#                                                                                  

if [ -f ~/.bashrc ]; then
	. ~/.bashrc
fi
PATH=$PATH:$HOME/.local/bin:$HOME/bin
export PATH
export MALLOC_ARENA_MAX=1
export DM_HOME=/opt/dmdbms
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin
export PATH=$PATH:$DM_HOME/bin:$DM_HOME/tool
export PS1="[`whoami`@`hostname`:"'\w]$ '
alias ds='disql SYSDBA/SYSDBA:5236 '
alias dsql='disql SYSDBA/SYSDBA:5236  \`'
alias dssql='disql -S SYSDBA/SYSDBA:5236  \`'
alias dmlog='cd $DM_HOME/log'

#==============================================================#                                                                                  
挂载达梦安装镜像                                                                                  
#==============================================================#                                                                                  

总用量 959M
-r-xr-xr-x. 1 root root 2.7M 11月 21 16:25 DM8 Install.pdf
-r-xr-xr-x. 1 root root 957M 11月 21 16:27 DMInstall.bin

#==============================================================#                                                                                  
安装达梦数据库软件                                                                                  
#==============================================================#                                                                                  

解压安装程序......... 
2022-12-20 17:32:40 
[INFO] 安装达梦数据库...
2022-12-20 17:32:40 
[INFO] 安装 基础 模块...
2022-12-20 17:32:45 
[INFO] 安装 服务器 模块...
2022-12-20 17:32:45 
[INFO] 安装 客户端 模块...
2022-12-20 17:32:50 
[INFO] 安装 驱动 模块...
2022-12-20 17:32:52 
[INFO] 安装 手册 模块...
2022-12-20 17:32:52 
[INFO] 安装 服务 模块...
2022-12-20 17:32:54 
[INFO] 移动日志文件。
2022-12-20 17:32:54 
[INFO] 更改安装目录权限完成。
2022-12-20 17:32:54 
[INFO] 正在启动DmAPService服务...
2022-12-20 17:32:55 
[INFO] 启动DmAPService服务成功。
2022-12-20 17:32:55 
[INFO] 安装达梦数据库完成。

#==============================================================#                                                                                  
初始化达梦数据库                                                                                  
#==============================================================#                                                                                  

initdb V8
db version: 0x7000c
file dm.key not found, use default license!
License will expire on 2023-11-21
Normal of FAST
Normal of DEFAULT
Normal of RECYCLE
Normal of KEEP
Normal of ROLL

 log file path: /dmdata/DAMENG/DAMENG01.log


 log file path: /dmdata/DAMENG/DAMENG02.log

write to dir [/dmdata/DAMENG].
create dm database success. 2022-12-20 17:33:00

#==============================================================#                                                                                  
注册实例服务                                                                                    
#==============================================================#                                                                                  

Created symlink from /etc/systemd/system/multi-user.target.wants/DmServiceDAMENG.service to /usr/lib/systemd/system/DmServiceDAMENG.service.
创建服务(DmServiceDAMENG)完成

#==============================================================#                                                                                  
启停数据库                                                                                       
#==============================================================#                                                                                  


后台启动数据库：                                                                                  

Starting DmServiceDAMENG:                                  [ OK ]
DmServiceDAMENG (pid 4946) is running.

查询数据库基础参数信息：                                                                                  

密钥过期时间：2023-11-21

数据库参数项              数据库参数值                 
------------------------------- -----------------------------------
实例名                       GRP1_DW_03
DM Database Server x64 V8       --03134283950-20221121-175072-20024
簇大小                       32
页大小                       32
大小写敏感                 1
字符集                       1
varchar是否以字符为单位 0

#==============================================================#                                                                                  
创建归档和备份脚本                                                                                  
#==============================================================#                                                                                  

创建数据库归档脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 378 12月 20 17:33 /home/dmdba/scripts/conf_arch.sql

创建数据库备份脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 780 12月 20 17:33 /home/dmdba/scripts/conf_fullbackup.sql
-rw-r--r--. 1 dmdba dinstall 1.5K 12月 20 17:33 /home/dmdba/scripts/conf_incrbackup.sql

创建 DMDBA 用户脚本，密码 SYSDBA ：                                                                                  

-rw-r--r--. 1 dmdba dinstall 696 12月 20 17:33 /home/dmdba/scripts/ct_dbuser.sql

#==============================================================#                                                                                  
创建达梦数据库优化脚本                                                                                  
#==============================================================#                                                                                  

创建数据库参数配置脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 14K 12月 20 17:33 /home/dmdba/scripts/conf_para.sql

创建数据库优化结果查询脚本：                                                                                  

-rw-r--r--. 1 dmdba dinstall 2.2K 12月 20 17:33 /home/dmdba/scripts/query_dm.sql

#==============================================================#                                                                                  
优化数据库基础参数                                                                                  
#==============================================================#                                                                                  

密钥过期时间：2023-11-21

修改cpu相关参数: 
 
SP_SET_PARA_VALUE(2,'WORKER_THREADS',1);
SP_SET_PARA_VALUE(2,'TASK_THREADS',4);
SP_SET_PARA_VALUE(2,'IO_THR_GROUPS',2);

修改内存池相关参数: 
 
SP_SET_PARA_VALUE(2,'MAX_OS_MEMORY',80);
SP_SET_PARA_VALUE(2,'MEMORY_POOL',100);
SP_SET_PARA_VALUE(2,'MEMORY_N_POOLS',1);
SP_SET_PARA_VALUE(2,'MEMORY_TARGET',0);

修改缓冲区相关参数: 
 
SP_SET_PARA_VALUE(2,'BUFFER',1000);
SP_SET_PARA_VALUE(2,'MAX_BUFFER',1000);
SP_SET_PARA_VALUE(2,'BUFFER_POOLS',3);
SP_SET_PARA_VALUE(2,'RECYCLE',80);
SP_SET_PARA_VALUE(2,'RECYCLE_POOLS',2);

修改fast_pool相关参数: 
 
SP_SET_PARA_VALUE(2,'FAST_POOL_PAGES',3000);
SP_SET_PARA_VALUE(2,'FAST_ROLL_PAGES',1000);

修改内存检测参数为1: 
 
SP_SET_PARA_VALUE(2,'MEMORY_MAGIC_CHECK',1);

非DSC环境将ENABLE_FREQROOTS设置为1,注意DM7 V$instance视图没有dsc_role字段,DM7这部分可以删掉: 
 
SP_SET_PARA_VALUE(2,'ENABLE_FREQROOTS',1);

修改HASH相关参数: 
 
SP_SET_PARA_VALUE(1,'HJ_BUF_GLOBAL_SIZE',500);
SP_SET_PARA_VALUE(1,'HJ_BUF_SIZE',50);
SP_SET_PARA_VALUE(1,'HAGR_BUF_GLOBAL_SIZE',500);
SP_SET_PARA_VALUE(1,'HAGR_BUF_SIZE',50);

修改排序相关参数: 
 
SP_SET_PARA_VALUE(2,'SORT_FLAG',0);
SP_SET_PARA_VALUE(2,'SORT_BLK_SIZE',1);
SP_SET_PARA_VALUE(2,'SORT_BUF_SIZE',10);
SP_SET_PARA_VALUE(2,'SORT_BUF_GLOBAL_SIZE',500);

修改其他内存参数: 
 
SP_SET_PARA_VALUE(2,'RLOG_POOL_SIZE',256);
SP_SET_PARA_VALUE(2,'CACHE_POOL_SIZE',200);
SP_SET_PARA_VALUE(2,'DICT_BUF_SIZE',50);
SP_SET_PARA_VALUE(2,'VM_POOL_TARGET',16384);
SP_SET_PARA_VALUE(2,'SESS_POOL_TARGET',16384);

修改实例相关参数: 
 
SP_SET_PARA_VALUE(2,'USE_PLN_POOL',1);
SP_SET_PARA_VALUE(2,'ENABLE_MONITOR',1);
SP_SET_PARA_VALUE(2,'TEMP_SIZE',1024);
SP_SET_PARA_VALUE(2,'TEMP_SPACE_LIMIT',102400);
SP_SET_PARA_VALUE(2,'MAX_SESSIONS',1500);
SP_SET_PARA_VALUE(2,'MAX_SESSION_STATEMENT',20000);
SP_SET_PARA_VALUE(2,'PK_WITH_CLUSTER',0);
SP_SET_PARA_VALUE(2,'ENABLE_ENCRYPT',0);

修改优化器相关参数: 
 
SP_SET_PARA_VALUE(2,'OLAP_FLAG',2);
SP_SET_PARA_VALUE(2,'VIEW_PULLUP_FLAG',1);
SP_SET_PARA_VALUE(2,'OPTIMIZER_MODE',1);
SP_SET_PARA_VALUE(2,'ADAPTIVE_NPLN_FLAG',0);

开启并行PURGE: 
 
SP_SET_PARA_VALUE(2,'PARALLEL_PURGE_FLAG',1);

开启手动并行: 
 
SP_SET_PARA_VALUE(2,'PARALLEL_POLICY',2);

UNDO_RETENTION如果放大，可以适当调大UNDO_EXTENT_NUM。负载高的时候，减少文件系统的申请/释放操作: 
 
SP_SET_PARA_VALUE(2,'UNDO_EXTENT_NUM',16);

开启SQL 注入HINT功能: 
 
SP_SET_PARA_VALUE(2,'ENABLE_INJECT_HINT',1);

开启数据异步追踪: 
 
SP_SET_PARA_VALUE(1,'SVR_LOG',1);

开启操作系统认证: 
 
sp_set_para_value(2,'ENABLE_LOCAL_OSAUTH',1);



重启数据库，优化参数生效                                                                                  

Stopping DmServiceDAMENG:                                  [ OK ]
Starting DmServiceDAMENG:                                  [ OK ]

#==============================================================#                                                                                  
查询数据库优化结果：                                                                                  
#==============================================================#                                                                                  

密钥过期时间：2023-11-21

PARA_NAME             DEFAULT_VALUE PARA_VALUE
--------------------- ------------- ----------
MAX_OS_MEMORY         100           80
MAX_SESSION_STATEMENT 10000         20000
TRX_VIEW_MODE         1             1
MAX_SESSIONS          10000         1500
IO_THR_GROUPS         8             2
ADAPTIVE_NPLN_FLAG    3             0
OPTIMIZER_MODE        1             1
TOP_DIS_HASH_FLAG     1             1
TOP_ORDER_OPT_FLAG    0             0
VIEW_PULLUP_FLAG      0             1
USE_PLN_POOL          1             1
TASK_THREADS          16            4
WORKER_THREADS        16            1
SESS_POOL_TARGET      16384         16384
SESS_POOL_SIZE        64            64
VM_POOL_TARGET        16384         16384
DICT_BUF_SIZE         50            50
HAGR_BUF_SIZE         500           50
HAGR_BUF_GLOBAL_SIZE  5000          1000
HJ_BUF_SIZE           500           50
HJ_BUF_GLOBAL_SIZE    5000          1000
SORT_FLAG             0             0
SORT_BUF_GLOBAL_SIZE  1000          500
SORT_BLK_SIZE         1             1
SORT_BUF_SIZE         20            10
MAX_BUFFER            1000          1000
RECYCLE_POOLS         3             1
RECYCLE               300           80
BUFFER_POOLS          9             3
BUFFER                1000          1000
MEMORY_MAGIC_CHECK    1             1
MEMORY_TARGET         15000         0
MEMORY_N_POOLS        1             1
MEMORY_POOL           500           100
PK_WITH_CLUSTER       0             0
ENABLE_MONITOR        1             1
SVR_LOG               0             1
DATETIME_FMT_MODE     0             0
COMPATIBLE_MODE       0             0
CLOB_LIKE_MAX_LEN     10240         10240
ENABLE_ENCRYPT        0             0
REDOS_PARALLEL_NUM    1             1
RLOG_POOL_SIZE        256           256
CACHE_POOL_SIZE       100           200
TEMP_SPACE_LIMIT      0             102400
TEMP_SIZE             10            1024
OLAP_FLAG             2             2

#==============================================================#                                                                                  
数据守护备库脱机恢复                                                                                  
#==============================================================#                                                                                  

正常关闭备数据库：                                                                                  

Stopping DmServiceDAMENG:                                  [ OK ]

拷贝主库的备份文件并授权：                                                                                  

BACKUP_FILE_01.bak                                                                                                                                                                 100%   22MB  91.1MB/s   00:00    
BACKUP_FILE_01.meta                                                                                                                                                                100%   90KB  42.3MB/s   00:00    

备库执行脱机数据库 dmrman 还原：                                                                                  

dmrman V8
RESTORE DATABASE '/dmdata/DAMENG/dm.ini' FROM BACKUPSET '/dmbak/BACKUP_FILE_01'
file dm.key not found, use default license!
Normal of FAST
Normal of DEFAULT
Normal of RECYCLE
Normal of KEEP
Normal of ROLL
[Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 
restore successfully.
time used: 00:00:02.461

备库执行 dmrman 数据库更新：                                                                                  

dmrman V8
RECOVER DATABASE '/dmdata/DAMENG/dm.ini' UPDATE DB_MAGIC
file dm.key not found, use default license!
Database mode = 2, oguid = 0
Normal of FAST
Normal of DEFAULT
Normal of RECYCLE
Normal of KEEP
Normal of ROLL
EP[0]'s cur_lsn[39191], file_lsn[39191]
recover successfully!
time used: 988.867(ms)

#==============================================================#                                                                                  
数据守护主备配置参数文件                                                                                  
#==============================================================#                                                                                  

备库配置 dm.ini 参数：                                                                                  

		ALTER_MODE_STATUS               = 1                     #Whether to permit database user to alter database mode and status by SQLs, 1: yes, 0: no
		ENABLE_OFFLINE_TS               = 2                     #Whether tablespace can be offline
		MAL_INI                         = 1                     #dmmal.ini
		ARCH_INI                        = 1                     #dmarch.ini

备库配置 dmmal.ini 参数：                                                                                  

MAL_CHECK_INTERVAL = 5
MAL_CONN_FAIL_INTERVAL = 5

[MAL_INST1]
MAL_INST_NAME = GRP1_DW_01
MAL_HOST = 172.16.2.26
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.26
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

[MAL_INST2]
MAL_INST_NAME = GRP1_DW_02
MAL_HOST = 172.16.2.27
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.27
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

[MAL_INST3]
MAL_INST_NAME = GRP1_DW_03
MAL_HOST = 172.16.2.28
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.28
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

备库配置 dmarch.ini 参数：                                                                                  

ARCH_WAIT_APPLY = 1

[ARCHIVE_LOCAL1]
        ARCH_TYPE            = LOCAL
        ARCH_DEST            = /dmarch/DAMENG
        ARCH_FILE_SIZE       = 1024
        ARCH_SPACE_LIMIT     = 102400

[ARCHIVE_REALTIME1]
ARCH_TYPE = REALTIME
ARCH_DEST = GRP1_DW_01

[ARCHIVE_REALTIME2]
ARCH_TYPE = REALTIME
ARCH_DEST = GRP1_DW_02

备库配置 dmwatcher.ini 参数：                                                                                  

[GRP1]
DW_TYPE = GLOBAL
DW_MODE = AUTO
DW_ERROR_TIME = 10
INST_ERROR_TIME = 10
INST_OGUID = 498860
INST_INI = /dmdata/DAMENG/dm.ini
INST_AUTO_RESTART = 1
INST_STARTUP_CMD = /opt/dmdbms/bin/DmServiceDAMENG start

备库配置 dmmonitor.ini 参数：                                                                                  

MON_DW_CONFIRM = 0
MON_LOG_PATH = /opt/dmdbms/log
MON_LOG_INTERVAL = 60
MON_LOG_FILE_SIZE = 32
MON_LOG_SPACE_LIMIT = 2048

[GRP1]
MON_INST_OGUID = 498860
MON_DW_IP = 172.16.2.26:12346
MON_DW_IP = 172.16.2.27:12346
MON_DW_IP = 172.16.2.28:12346

备库注册 dmwatcher 服务：                                                                                  

Created symlink from /etc/systemd/system/multi-user.target.wants/DmWatcherServiceGRP1.service to /usr/lib/systemd/system/DmWatcherServiceGRP1.service.
创建服务(DmWatcherServiceGRP1)完成

备库启动到 mount 状态：                                                                                  

Starting DmServiceDAMENG:                                  [ OK ]

备库修改模式：                                                                                  

密钥过期时间：2023-11-21

备库启动守护进程：                                                                                  

Starting DmWatcherServiceGRP1:                             [ OK ]


Connection to 192.168.2.28 closed.

节点 192.168.2.28 配置完成！                                                                                  


#==============================================================#                                                                                  
配置监视器主机                                                                                  
#==============================================================#                                                                                  


监视器主机开始执行配置：                                                                                  

 ███████   ████     ████  ████████ ██               ██  ██ ██                    ██              ██  ██
░██░░░░██ ░██░██   ██░██ ██░░░░░░ ░██              ░██ ░██░██                   ░██             ░██ ░██
░██    ░██░██░░██ ██ ░██░██       ░██       █████  ░██ ░██░██ ███████   ██████ ██████  ██████   ░██ ░██
░██    ░██░██ ░░███  ░██░█████████░██████  ██░░░██ ░██ ░██░██░░██░░░██ ██░░░░ ░░░██░  ░░░░░░██  ░██ ░██
░██    ░██░██  ░░█   ░██░░░░░░░░██░██░░░██░███████ ░██ ░██░██ ░██  ░██░░█████   ░██    ███████  ░██ ░██
░██    ██ ░██   ░    ░██       ░██░██  ░██░██░░░░  ░██ ░██░██ ░██  ░██ ░░░░░██  ░██   ██░░░░██  ░██ ░██
░███████  ░██        ░██ ████████ ░██  ░██░░██████ ███ ███░██ ███  ░██ ██████   ░░██ ░░████████ ███ ███
░░░░░░░   ░░         ░░ ░░░░░░░░  ░░   ░░  ░░░░░░ ░░░ ░░░ ░░ ░░░   ░░ ░░░░░░     ░░   ░░░░░░░░ ░░░ ░░░ 

/soft/DMShellInstall:行2511: wc_hostname_array: 坏的数组下标
达梦数据库开始安装：                                                                                  

#==============================================================#                                                                                  
打印系统信息                                                                                    
#==============================================================#                                                                                  

服务器时间:                                                                                      

2022年 12月 20日 星期二 18:16:45 CST

操作系统版本:                                                                                   

NAME="CentOS Linux"
VERSION="7 (Core)"
ID="centos"
ID_LIKE="rhel fedora"
VERSION_ID="7"
PRETTY_NAME="CentOS Linux 7 (Core)"
ANSI_COLOR="0;31"
CPE_NAME="cpe:/o:centos:centos:7"
HOME_URL="https://www.centos.org/"
BUG_REPORT_URL="https://bugs.centos.org/"

CENTOS_MANTISBT_PROJECT="CentOS-7"
CENTOS_MANTISBT_PROJECT_VERSION="7"
REDHAT_SUPPORT_PRODUCT="centos"
REDHAT_SUPPORT_PRODUCT_VERSION="7"


cpu信息:                                                                                            

Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                1
On-line CPU(s) list:   0
Thread(s) per core:    1
Core(s) per socket:    1
座：                 1
NUMA 节点：         1
厂商 ID：           GenuineIntel
CPU 系列：          6
型号：              142
型号名称：        Intel(R) Core(TM) i7-8565U CPU @ 1.80GHz
步进：              12
CPU MHz：             1992.001
BogoMIPS：            3984.00
超管理器厂商：  VMware
虚拟化类型：     完全
L1d 缓存：          32K
L1i 缓存：          32K
L2 缓存：           256K
L3 缓存：           8192K
NUMA 节点0 CPU：    0
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single ssbd ibrs ibpb stibp ibrs_enhanced fsgsbase tsc_adjust bmi1 avx2 smep bmi2 invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 arat md_clear spec_ctrl intel_stibp flush_l1d arch_capabilities

内存信息:                                                                                         

              total        used        free      shared  buff/cache   available
Mem:           2827         254        1449           9        1122        2407
Swap:          8191           0        8191
              total        used        free      shared  buff/cache   available
Mem:           2.8G        254M        1.4G        9.4M        1.1G        2.4G
Swap:          8.0G          0B        8.0G

挂载信息:                                                                                         

/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=dc24af02-0269-4d90-88b9-c6fdb8c27470 /boot                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0
/dev/sr0                /mnt/cdrom              iso9660 defaults        0 0

目录信息:                                                                                         

文件系统                 容量  已用  可用 已用% 挂载点
devtmpfs                 1.4G     0  1.4G    0% /dev
tmpfs                    1.4G     0  1.4G    0% /dev/shm
tmpfs                    1.4G  9.5M  1.4G    1% /run
tmpfs                    1.4G     0  1.4G    0% /sys/fs/cgroup
/dev/mapper/centos-root   91G  2.7G   89G    3% /
/dev/sr0                 4.4G  4.4G     0  100% /mnt/cdrom
/dev/sda1               1014M  151M  864M   15% /boot
tmpfs                    283M     0  283M    0% /run/user/0

#==============================================================#                                                                                  
关闭 SWAP 功能                                                                                    
#==============================================================#                                                                                  

              total        used        free      shared  buff/cache   available
Mem:        2895196      254108     1491460        9640     1149628     2472440
Swap:             0           0           0

#/dev/mapper/centos-swap swap                    swap    defaults        0 0

#==============================================================#                                                                                  
禁用防火墙                                                                                       
#==============================================================#                                                                                  

● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)

12月 20 18:08:18 centos7 systemd[1]: Starting firewalld - dynamic firewall daemon...
12月 20 18:08:19 centos7 systemd[1]: Started firewalld - dynamic firewall daemon.
12月 20 18:08:19 centos7 firewalld[727]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure configuration option. It will be removed in a future release. Please consider disabling it now.
12月 20 18:16:45 centos7 systemd[1]: Stopping firewalld - dynamic firewall daemon...
12月 20 18:16:45 centos7 systemd[1]: Stopped firewalld - dynamic firewall daemon.

#==============================================================#                                                                                  
禁用 selinux                                                                                        
#==============================================================#                                                                                  

SELINUX=disabled
SELINUXTYPE=targeted 

#==============================================================#                                                                                  
配置时间同步                                                                                    
#==============================================================#                                                                                  

Removed symlink /etc/systemd/system/multi-user.target.wants/chronyd.service.
● chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:chronyd(8)
           man:chrony.conf(5)

12月 20 18:08:18 centos7 systemd[1]: Starting NTP client/server...
12月 20 18:08:18 centos7 chronyd[700]: chronyd version 3.4 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +SECHASH +IPV6 +DEBUG)
12月 20 18:08:18 centos7 chronyd[700]: Frequency 0.000 +/- 1000000.000 ppm read from /var/lib/chrony/drift
12月 20 18:08:18 centos7 systemd[1]: Started NTP client/server.
12月 20 18:16:46 centos7 systemd[1]: Stopping NTP client/server...
12月 20 18:16:46 centos7 systemd[1]: Stopped NTP client/server.
2022年 12月 20日 星期二 18:16:46 CST

no crontab for root

#==============================================================#                                                                                  
禁用透明大页 & 禁用NUMA & 开启 I/0 schedule                                                                                  
#==============================================================#                                                                                  

index=0
kernel=/boot/vmlinuz-3.10.0-1160.el7.x86_64
args="ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet LANG=zh_CN.UTF-8 numa=off transparent_hugepage=never elevator=deadline"
--
index=1
kernel=/boot/vmlinuz-0-rescue-f4a41440d98d417dbb5516d46b966467
args="ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet numa=off transparent_hugepage=never elevator=deadline"

#==============================================================#                                                                                  
创建 DMDBA 用户以及安装目录                                                                                  
#==============================================================#                                                                                  

更改用户 dmdba 的密码 。
passwd：所有的身份验证令牌已经成功更新。

dmdba:x:54321:54321::/home/dmdba:/bin/bash

uid=54321(dmdba) gid=54321(dinstall) 组=54321(dinstall),54322(dmdba)

#==============================================================#                                                                                  
配置系统参数                                                                                    
#==============================================================#                                                                                  

fs.aio-max-nr = 1048576
fs.file-max = 6815744
kernel.shmmni = 4096
kernel.sem = 250 32000 100 128
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
vm.swappiness = 0
vm.dirty_background_ratio = 3
vm.dirty_ratio = 80
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100
sysctl: cannot stat /proc/sys/vm/numa_stat: 没有那个文件或目录
vm.overcommit_memory = 0

#==============================================================#                                                                                  
配置用户限制                                                                                    
#==============================================================#                                                                                  

dmdba - nice   0
dmdba - as     unlimited
dmdba - fsize  unlimited
dmdba - nproc  131072
dmdba - nofile 131072
dmdba - core   unlimited
dmdba - data   unlimited
root  - nice   0
root  - as     unlimited
root  - fsize  unlimited
root  - nproc  131072
root  - nofile 131072
root  - core   unlimited
root  - data   unlimited

[Manager]
DefaultLimitCORE=infinity
DefaultLimitNOFILE=65536
DefaultLimitNPROC=10240

auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_securetty.so
auth       substack     system-auth
auth       include      postlogin
account    required     pam_nologin.so
account    include      system-auth
password   include      system-auth
session    required     pam_selinux.so close
session    required     pam_loginuid.so
session    optional     pam_console.so
session    required     pam_selinux.so open
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    include      system-auth
session    include      postlogin
-session   optional     pam_ck_connector.so
session required pam_limits.so
session required /lib64/security/pam_limits.so

#==============================================================#                                                                                  
禁用 RemoveIPC                                                                                      
#==============================================================#                                                                                  

[Login]
RemoveIPC=no

#==============================================================#                                                                                  
配置语言中文                                                                                    
#==============================================================#                                                                                  

export LANG=zh_CN.UTF-8

#==============================================================#                                                                                  
配置用户环境变量                                                                                  
#==============================================================#                                                                                  

if [ -f ~/.bashrc ]; then
	. ~/.bashrc
fi
PATH=$PATH:$HOME/.local/bin:$HOME/bin
export PATH
export MALLOC_ARENA_MAX=1
export DM_HOME=/opt/dmdbms
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin
export PATH=$PATH:$DM_HOME/bin:$DM_HOME/tool
export PS1="[`whoami`@`hostname`:"'\w]$ '
alias ds='disql SYSDBA/SYSDBA:5236 '
alias dsql='disql SYSDBA/SYSDBA:5236  \`'
alias dssql='disql -S SYSDBA/SYSDBA:5236  \`'
alias dmlog='cd $DM_HOME/log'

#==============================================================#                                                                                  
挂载达梦安装镜像                                                                                  
#==============================================================#                                                                                  

总用量 959M
-r-xr-xr-x. 1 root root 2.7M 11月 21 16:25 DM8 Install.pdf
-r-xr-xr-x. 1 root root 957M 11月 21 16:27 DMInstall.bin

#==============================================================#                                                                                  
安装达梦数据库软件                                                                                  
#==============================================================#                                                                                  

解压安装程序......... 
2022-12-20 18:17:13 
[INFO] 安装达梦数据库...
2022-12-20 18:17:13 
[INFO] 安装 基础 模块...
2022-12-20 18:17:18 
[INFO] 安装 服务器 模块...
2022-12-20 18:17:19 
[INFO] 安装 客户端 模块...
2022-12-20 18:17:23 
[INFO] 安装 驱动 模块...
2022-12-20 18:17:24 
[INFO] 安装 手册 模块...
2022-12-20 18:17:25 
[INFO] 安装 服务 模块...
2022-12-20 18:17:27 
[INFO] 移动日志文件。
2022-12-20 18:17:27 
[INFO] 更改安装目录权限完成。
2022-12-20 18:17:27 
[INFO] 正在启动DmAPService服务...
2022-12-20 18:17:28 
[INFO] 启动DmAPService服务成功。
2022-12-20 18:17:28 
[INFO] 安装达梦数据库完成。

#==============================================================#                                                                                  
数据守护主备配置参数文件                                                                                  
#==============================================================#                                                                                  

监视器主机配置 dmmonitor.ini 参数：                                                                                  

MON_DW_CONFIRM = 1
MON_LOG_PATH = /opt/dmdbms/log
MON_LOG_INTERVAL = 60
MON_LOG_FILE_SIZE = 32
MON_LOG_SPACE_LIMIT = 2048

[GRP1]
MON_INST_OGUID = 498860
MON_DW_IP = 172.16.2.26:12346
MON_DW_IP = 172.16.2.27:12346
MON_DW_IP = 172.16.2.28:12346

监视主机注册监视器服务：                                                                                  

Created symlink from /etc/systemd/system/multi-user.target.wants/DmMonitorServiceGRP1.service to /usr/lib/systemd/system/DmMonitorServiceGRP1.service.
创建服务(DmMonitorServiceGRP1)完成

监视主机启动监视进程：                                                                                  

Starting DmMonitorServiceGRP1:                             [ OK ]

Connection to 192.168.2.29 closed.

监视器主机配置完成！                                                                                  

#==============================================================#                                                                                  
数据守护主备配置参数文件                                                                                  
#==============================================================#                                                                                  

主库配置 dm.ini 参数：                                                                                  

		ALTER_MODE_STATUS               = 1                     #Whether to permit database user to alter database mode and status by SQLs, 1: yes, 0: no
		ENABLE_OFFLINE_TS               = 2                     #Whether tablespace can be offline
		MAL_INI                         = 1                     #dmmal.ini
		ARCH_INI                        = 1                     #dmarch.ini

主库配置 dmmal.ini 参数：                                                                                  

MAL_CHECK_INTERVAL = 5
MAL_CONN_FAIL_INTERVAL = 5

[MAL_INST1]
MAL_INST_NAME = GRP1_DW_01
MAL_HOST = 172.16.2.26
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.26
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

[MAL_INST2]
MAL_INST_NAME = GRP1_DW_02
MAL_HOST = 172.16.2.27
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.27
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

[MAL_INST3]
MAL_INST_NAME = GRP1_DW_03
MAL_HOST = 172.16.2.28
MAL_PORT = 12345
MAL_INST_HOST = 192.168.2.28
MAL_INST_PORT = 5236
MAL_DW_PORT = 12346
MAL_INST_DW_PORT = 12347

主库配置 dmarch.ini 参数：                                                                                  

ARCH_WAIT_APPLY = 1

[ARCHIVE_LOCAL1]
        ARCH_TYPE            = LOCAL
        ARCH_DEST            = /dmarch/DAMENG
        ARCH_FILE_SIZE       = 1024
        ARCH_SPACE_LIMIT     = 102400

[ARCHIVE_REALTIME1]
ARCH_TYPE = REALTIME
ARCH_DEST = GRP1_DW_02

[ARCHIVE_REALTIME2]
ARCH_TYPE = REALTIME
ARCH_DEST = GRP1_DW_03

主库配置 dmwatcher.ini 参数：                                                                                  

[GRP1]
DW_TYPE = GLOBAL
DW_MODE = AUTO
DW_ERROR_TIME = 10
INST_ERROR_TIME = 10
INST_OGUID = 498860
INST_INI = /dmdata/DAMENG/dm.ini
INST_AUTO_RESTART = 1
INST_STARTUP_CMD = /opt/dmdbms/bin/DmServiceDAMENG start

主库配置 dmmonitor.ini 参数：                                                                                  

MON_DW_CONFIRM = 0
MON_LOG_PATH = /opt/dmdbms/log
MON_LOG_INTERVAL = 60
MON_LOG_FILE_SIZE = 32
MON_LOG_SPACE_LIMIT = 2048

[GRP1]
MON_INST_OGUID = 498860
MON_DW_IP = 172.16.2.26:12346
MON_DW_IP = 172.16.2.27:12346
MON_DW_IP = 172.16.2.28:12346

主库注册 dmwatcher 服务：                                                                                  

Created symlink from /etc/systemd/system/multi-user.target.wants/DmWatcherServiceGRP1.service to /usr/lib/systemd/system/DmWatcherServiceGRP1.service.
创建服务(DmWatcherServiceGRP1)完成

主库启动到 mount 状态：                                                                                  

Starting DmServiceDAMENG:                                  [ OK ]

主库修改模式：                                                                                  

密钥过期时间：2023-11-21

主库启动守护进程：                                                                                  

Starting DmWatcherServiceGRP1:                             [ OK ]


恭喜您，达梦数据守护已经安装完成！                                                                                  
[root@centos7 soft]# su - dmdba
[dmdba@dw01:~]$ dmmonitor /dmdata/DAMENG/dmmonitor_GRP1.ini 
[monitor]         2022-12-20 17:34:02: DMMONITOR[4.0] V8
[monitor]         2022-12-20 17:34:02: DMMONITOR[4.0] IS READY.

[monitor]         2022-12-20 17:34:03: 收到守护进程(GRP1_DW_01)消息
                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN            
                  2022-12-20 17:34:02  OPEN           OK        GRP1_DW_01       OPEN        PRIMARY   VALID    4        39351           39352           

[monitor]         2022-12-20 17:34:03: 
#--------------------------------------------------------------------------------#
GET MONITOR CONNECT INFO FROM DMWATCHER(GRP1_DW_01), THE FIRST LINE IS SELF INFO.

DW_CONN_TIME         MON_CONFIRM    MID            MON_IP                   MON_VERSION                                                     
2022-12-20 17:34:02  FALSE          233943158      ::ffff:172.16.2.26       DMMONITOR[4.0] V8
                                              
2022-12-20 17:33:36  TRUE           1897006016     ::ffff:172.16.2.29       DMMONITOR[4.0] V8
                                              
#--------------------------------------------------------------------------------#

[monitor]         2022-12-20 17:34:03: 收到守护进程(GRP1_DW_02)消息
                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN            
                  2022-12-20 17:34:54  OPEN           OK        GRP1_DW_02       OPEN        STANDBY   VALID    4        39351           39351           

[monitor]         2022-12-20 17:34:03: 收到守护进程(GRP1_DW_03)消息
                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN            
                  2022-12-20 17:36:17  OPEN           OK        GRP1_DW_03       OPEN        STANDBY   VALID    4        39351           39351           

login
用户名:SYSDBA
密码:
[monitor]         2022-12-20 17:34:11: 登录监视器成功!

SWITCHOVER GRP1_DW_03
[monitor]         2022-12-20 17:34:23: 开始切换实例GRP1_DW_03
[monitor]         2022-12-20 17:34:23: 通知守护进程GRP1_DW_01切换SWITCHOVER状态
[monitor]         2022-12-20 17:34:24: 守护进程(GRP1_DW_01)状态切换 [OPEN-->SWITCHOVER]
[monitor]         2022-12-20 17:34:25: 切换守护进程GRP1_DW_01为SWITCHOVER状态成功
[monitor]         2022-12-20 17:34:25: 通知守护进程GRP1_DW_03切换SWITCHOVER状态
[monitor]         2022-12-20 17:34:25: 守护进程(GRP1_DW_03)状态切换 [OPEN-->SWITCHOVER]
[monitor]         2022-12-20 17:34:26: 切换守护进程GRP1_DW_03为SWITCHOVER状态成功
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_01开始执行SP_SET_GLOBAL_DW_STATUS(0, 6)语句
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_01执行SP_SET_GLOBAL_DW_STATUS(0, 6)语句成功
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_03开始执行SP_SET_GLOBAL_DW_STATUS(0, 6)语句
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_03执行SP_SET_GLOBAL_DW_STATUS(0, 6)语句成功
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_01开始执行ALTER DATABASE MOUNT语句
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_01执行ALTER DATABASE MOUNT语句成功
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_03开始执行SP_APPLY_KEEP_PKG()语句
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_03执行SP_APPLY_KEEP_PKG()语句成功
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_03开始执行ALTER DATABASE MOUNT语句
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_03执行ALTER DATABASE MOUNT语句成功
[monitor]         2022-12-20 17:34:26: 实例GRP1_DW_01开始执行ALTER DATABASE STANDBY语句
[monitor]         2022-12-20 17:34:27: 实例GRP1_DW_01执行ALTER DATABASE STANDBY语句成功
[monitor]         2022-12-20 17:34:27: 实例GRP1_DW_03开始执行ALTER DATABASE PRIMARY语句
[monitor]         2022-12-20 17:34:27: 实例GRP1_DW_03执行ALTER DATABASE PRIMARY语句成功
[monitor]         2022-12-20 17:34:27: 通知实例GRP1_DW_03修改所有归档状态无效
[monitor]         2022-12-20 17:34:27: 修改所有实例归档为无效状态成功
[monitor]         2022-12-20 17:34:27: 实例GRP1_DW_01开始执行ALTER DATABASE OPEN FORCE语句
[monitor]         2022-12-20 17:34:28: 实例GRP1_DW_01执行ALTER DATABASE OPEN FORCE语句成功
[monitor]         2022-12-20 17:34:28: 实例GRP1_DW_03开始执行ALTER DATABASE OPEN FORCE语句
[monitor]         2022-12-20 17:34:28: 实例GRP1_DW_03执行ALTER DATABASE OPEN FORCE语句成功
[monitor]         2022-12-20 17:34:28: 实例GRP1_DW_01开始执行SP_SET_GLOBAL_DW_STATUS(6, 0)语句
[monitor]         2022-12-20 17:34:28: 实例GRP1_DW_01执行SP_SET_GLOBAL_DW_STATUS(6, 0)语句成功
[monitor]         2022-12-20 17:34:28: 实例GRP1_DW_03开始执行SP_SET_GLOBAL_DW_STATUS(6, 0)语句
[monitor]         2022-12-20 17:34:28: 实例GRP1_DW_03执行SP_SET_GLOBAL_DW_STATUS(6, 0)语句成功
[monitor]         2022-12-20 17:34:28: 通知守护进程GRP1_DW_01切换OPEN状态
[monitor]         2022-12-20 17:34:28: 守护进程(GRP1_DW_01)状态切换 [SWITCHOVER-->OPEN]
[monitor]         2022-12-20 17:34:29: 切换守护进程GRP1_DW_01为OPEN状态成功
[monitor]         2022-12-20 17:34:29: 通知守护进程GRP1_DW_03切换OPEN状态
[monitor]         2022-12-20 17:34:29: 守护进程(GRP1_DW_03)状态切换 [SWITCHOVER-->OPEN]
[monitor]         2022-12-20 17:34:30: 切换守护进程GRP1_DW_03为OPEN状态成功
[monitor]         2022-12-20 17:34:30: 通知组(GRP1)的守护进程执行清理操作
[monitor]         2022-12-20 17:34:30: 清理守护进程(GRP1_DW_01)请求成功
[monitor]         2022-12-20 17:34:30: 清理守护进程(GRP1_DW_02)请求成功
2022-12-20 17:34:30 
#================================================================================#
GROUP            OGUID       MON_CONFIRM     MODE            MPP_FLAG  
GRP1             498860      FALSE           AUTO            FALSE     


<<DATABASE GLOBAL INFO:>>
DW_IP               MAL_DW_PORT  WTIME                WTYPE     WCTLSTAT  WSTATUS        INAME            INST_OK   N_EP  N_OK  ISTATUS     IMODE     DSC_STATUS     RTYPE     RSTAT    
172.16.2.28         12346        2022-12-20 17:36:45  GLOBAL    VALID     OPEN           GRP1_DW_03       OK        1     1     OPEN        PRIMARY   DSC_OPEN       REALTIME  VALID    

EP INFO:
INST_IP             INST_PORT  INST_OK   INAME            ISTATUS     IMODE     DSC_SEQNO  DSC_CTL_NODE RTYPE     RSTAT    FSEQ            FLSN            CSEQ            CLSN            DW_STAT_FLAG          
192.168.2.28        5236       OK        GRP1_DW_03       OPEN        PRIMARY   0          0            REALTIME  VALID    4803            39518           4803            39518           NONE                  

<<DATABASE GLOBAL INFO:>>
DW_IP               MAL_DW_PORT  WTIME                WTYPE     WCTLSTAT  WSTATUS        INAME            INST_OK   N_EP  N_OK  ISTATUS     IMODE     DSC_STATUS     RTYPE     RSTAT    
172.16.2.26         12346        2022-12-20 17:34:30  GLOBAL    VALID     OPEN           GRP1_DW_01       OK        1     1     OPEN        STANDBY   DSC_OPEN       REALTIME  INVALID  

EP INFO:
INST_IP             INST_PORT  INST_OK   INAME            ISTATUS     IMODE     DSC_SEQNO  DSC_CTL_NODE RTYPE     RSTAT    FSEQ            FLSN            CSEQ            CLSN            DW_STAT_FLAG          
192.168.2.26        5236       OK        GRP1_DW_01       OPEN        STANDBY   0          0            REALTIME  INVALID  4802            39361           4802            39361           NONE                  

DATABASE(GRP1_DW_01) APPLY INFO FROM (GRP1_DW_03), REDOS_PARALLEL_NUM (1), WAIT_APPLY[TRUE]:
DSC_SEQNO[0], (RSEQ, SSEQ, KSEQ)[4802, 4802, 4802], (RLSN, SLSN, KLSN)[39361, 39361, 39361], N_TSK[0], TSK_MEM_USE[0] 
REDO_LSN_ARR: (39361)


<<DATABASE GLOBAL INFO:>>
DW_IP               MAL_DW_PORT  WTIME                WTYPE     WCTLSTAT  WSTATUS        INAME            INST_OK   N_EP  N_OK  ISTATUS     IMODE     DSC_STATUS     RTYPE     RSTAT    
172.16.2.27         12346        2022-12-20 17:35:21  GLOBAL    VALID     OPEN           GRP1_DW_02       OK        1     1     OPEN        STANDBY   DSC_OPEN       REALTIME  INVALID  

EP INFO:
INST_IP             INST_PORT  INST_OK   INAME            ISTATUS     IMODE     DSC_SEQNO  DSC_CTL_NODE RTYPE     RSTAT    FSEQ            FLSN            CSEQ            CLSN            DW_STAT_FLAG          
192.168.2.27        5236       OK        GRP1_DW_02       OPEN        STANDBY   0          0            REALTIME  INVALID  4785            39361           4785            39361           NONE                  

DATABASE(GRP1_DW_02) APPLY INFO FROM (GRP1_DW_01), REDOS_PARALLEL_NUM (1), WAIT_APPLY[TRUE]:
DSC_SEQNO[0], (RSEQ, SSEQ, KSEQ)[4802, 4802, 4802], (RLSN, SLSN, KLSN)[39361, 39361, 39361], N_TSK[0], TSK_MEM_USE[0] 
REDO_LSN_ARR: (39361)


#================================================================================#

[monitor]         2022-12-20 17:34:30: 清理守护进程(GRP1_DW_03)请求成功
[monitor]         2022-12-20 17:34:30: 实例GRP1_DW_03切换成功

[monitor]         2022-12-20 17:34:32: 守护进程(GRP1_DW_03)状态切换 [OPEN-->RECOVERY]
                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN            
                  2022-12-20 17:36:47  RECOVERY       OK        GRP1_DW_03       OPEN        PRIMARY   VALID    5        39519           39519           

[monitor]         2022-12-20 17:34:34: 守护进程(GRP1_DW_03)状态切换 [RECOVERY-->OPEN]
                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN            
                  2022-12-20 17:36:49  OPEN           OK        GRP1_DW_03       OPEN        PRIMARY   VALID    5        39520           39520           

[monitor]         2022-12-20 17:34:34: 守护进程(GRP1_DW_01)状态切换 [OPEN-->UNIFY EP]
                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN            
                  2022-12-20 17:34:34  UNIFY EP       OK        GRP1_DW_01       OPEN        STANDBY   VALID    5        39519           39519           

[monitor]         2022-12-20 17:34:35: 守护进程(GRP1_DW_01)状态切换 [UNIFY EP-->OPEN]
                  WTIME                WSTATUS        INST_OK   INAME            ISTATUS     IMODE     RSTAT    N_OPEN   FLSN            CLSN            
                  2022-12-20 17:34:35  OPEN           OK        GRP1_DW_01       OPEN        STANDBY   VALID    5        39520           39520           

exit
[dmdba@dw01:~]$ exit
登出

[END] 2022/12/20 10:32:28
